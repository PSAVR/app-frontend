<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mi cuenta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../styles/cuenta.css" />
</head>
<body>
    <canvas id="lavaCanvas"
      width="2048" height="1024"
      style="position:fixed; top:0; left:0; width:100%; height:100%;
         z-index:-1; pointer-events:none;"></canvas>
      <div class="shell">
      <div class="card">
      <h1>Mi Cuenta</h1>

      <div class="row">
        <div class="label">Email:</div>
        <div class="value" id="vEmail">—</div>
      </div>
      <div class="row">
        <div class="label">Username:</div>
        <div class="value" id="vUser">—</div>
      </div>
      <div class="row">
        <div class="label">Género:</div>
        <div class="value" id="vGender">—</div>
      </div>
      <div class="row">
        <div class="label">Institución:</div>
        <div class="value" id="vInst">—</div>
      </div>
      <div class="row">
        <div class="label">Fecha de Nacimiento:</div>
        <div class="value" id="vDob">—</div>
      </div>

      <div class="actions">
        <button id="btnDelete" class="btn btn-danger">Eliminar Cuenta</button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="dialog">
      <h2>¿Eliminar tu cuenta?</h2>
      <p>Esta acción es permanente. Se eliminarán tus sesiones, detalles y progreso.</p>
      <div class="buttons">
        <button id="modalNo" class="btn btn-outline">Cancelar</button>
        <button id="modalYes" class="btn btn-danger">Sí, eliminar</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = `${location.protocol}//${location.hostname}:4000`;
    console.log('[cuenta] API_BASE =', API_BASE);

    const $ = (s) => document.querySelector(s);

    function formatDateISOtoLocal(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      } catch { return '—'; }
    }

    const modal = $('#confirmModal');
    const modalYes = $('#modalYes');
    const modalNo  = $('#modalNo');

    function openModal() {
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('open');
      modalYes.focus();
    }
    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    let me = null;

    async function fetchMe(){
      const r = await fetch(`${API_BASE}/api/auth/me`, { credentials:'include' });
      if (!r.ok) return null;
      return await r.json();
    }

    const safeLogout = typeof logout === 'function'
  ? logout
  : () => {
      try { fetch(`${API_BASE}/api/auth/logout`, { method:'POST', credentials:'include' }); } catch {}
      localStorage.removeItem('user_id');
      window.location.replace('../index.html');
    };

    async function handleDelete(userId){
      try{
        const r = await fetch(`${API_BASE}/api/users/${userId}`, {
          method:'DELETE',
          credentials:'include'
        });

        if (!r.ok) {
          const payload = await r.json().catch(()=>({}));
          alert(`No se pudo eliminar la cuenta.\n${JSON.stringify(payload)}`);
          return;
        }
        alert('Cuenta eliminada correctamente.');
        await safeLogout(); 
      }catch(e){
        alert('Error eliminando la cuenta.');
      }
    }

    $('#btnDelete').addEventListener('click', openModal);
    modalNo.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    modalYes.addEventListener('click', async ()=>{
      modalYes.disabled = true;
      try{
        closeModal();
        await handleDelete(me?.user_id ?? me?.id);
      } finally {
        modalYes.disabled = false;
      }
    });

    (async function init(){
      me = await fetchMe();
      if (!me || !me.user_id) {
        alert('Tu sesión no está activa. Vuelve a iniciar sesión.');
        return location.href = '../index.html';
      }
      $('#vEmail').textContent  = me.email ?? '—';
      $('#vUser').textContent   = me.username ?? me.name ?? '—';
      $('#vGender').textContent = me.gender ?? '—';
      $('#vInst').textContent   = me.college ?? '—';
      $('#vDob').textContent    = formatDateISOtoLocal(me.birthdate);
      localStorage.setItem('user_id', String(me.user_id));
    })();
  </script>
  <script src="./js/fondo-lava.js"></script>
  <script src="./js/logout.js"></script>
  <script src="./js/home-icon.js"></script>
</body>
</html>