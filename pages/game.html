<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Selector de Escenario VR</title>
    <meta name="description" content="WebXR VR Level Selector">
    <script src="https://unpkg.com/meshoptimizer@0.20.0/meshopt_decoder.js"></script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <script>
      window.MeshoptDecoder = MeshoptDecoder;

      (function patchAframeGltfModelMeshopt() {
        function applyDecoder(cmpInstance) {
          const loader = cmpInstance && (cmpInstance.loader || cmpInstance.system?.loader);
          if (loader && loader.setMeshoptDecoder && window.MeshoptDecoder) {
            loader.setMeshoptDecoder(window.MeshoptDecoder);
            if (window.MeshoptDecoder.ready && typeof window.MeshoptDecoder.ready.then === "function") {
              window.MeshoptDecoder.ready.then(() => {
              });
            }
            return true;
          }
          return false;
        }

        function tryPatch() {
          const A = window.AFRAME;
          if (!A || !A.components || !A.components["gltf-model"]) return false;

          const Comp = A.components["gltf-model"].Component;
          if (!Comp || !Comp.prototype || Comp.prototype.__meshoptPatched) return false;

          const p = Comp.prototype;

          if (typeof p.init === "function") {
            const origInit = p.init;
            p.init = function () {
              origInit.call(this);
              applyDecoder(this);
            };
          }

          if (typeof p.update === "function") {
            const origUpdate = p.update;
            p.update = function () {
              applyDecoder(this);
              origUpdate.call(this);
              applyDecoder(this);
            };
          }

          p.__meshoptPatched = true;
          console.log("[Meshopt] Patched gltf-model init/update ‚úÖ");
          return true;
        }

        (function loop() {
          if (!tryPatch()) setTimeout(loop, 50);
        })();
      })();
    </script>


    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="../styles/game.css" />
  </head>
  <body>
  <div id="loader"
      style="
          position:fixed; inset:0;
          background:white;
          z-index:9999;
          opacity:1;
          display:flex;
          justify-content:center;
          align-items:center;
          flex-direction:column;
          transition: opacity 0.8s ease-in-out;
          ">

    <div class="spinner"
         style="
           width:65px;
           height:65px;
           border:6px solid #e1e1e1;
           border-top:6px solid #9b5de5; 
           border-radius:50%;
           animation:spin 1s linear infinite;">
    </div>
    <p style="
          margin-top:18px;
          font-size:18px;
          color:#4b3b74;
          font-weight:600;
       ">
      Cargando inmersi√≥n...
    </p>
  </div>  
    <div id="dom-overlay" style="position:fixed; inset:0; pointer-events:none;  z-index:10000">
      <div id="loading-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
           background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; pointer-events:auto;">
        <div style="background:white; padding:60px 80px; border-radius:20px; text-align:center; max-width:500px;">
          <h2 style="margin:0 0 20px; color:#333; font-size:28px;">Generando tus resultados,no salgas de esta vista</h2>
          <div class="spinner" style="margin:30px auto; width:60px; height:60px; border:6px solid #f3f3f3;
               border-top:6px solid #9b59b6; border-radius:50%; animation:spin 1s linear infinite;"></div>
          <style>@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
        </div>
      </div>

      <div id="result-modal" class="result-overlay" style="display:none; pointer-events:auto;">
        <div class="result-card">
          <h3 class="result-title">Resultados</h3>
          <p id="result-message" class="result-text">¬°Buen trabajo! Sigue intentandolo.</p>
          <div id="result-stars" class="result-stars"></div>
          <button id="result-ok" class="result-ok">Aceptar</button>
        </div>
      </div>
    </div>

    <a-scene lvl1-visitor-event="enabled: false" lvl2-visitor-event="enabled: false" lvl3-visitor-event="enabled: false" id="escena-vr" vr-mode-ui="enabled: true" shadow="type: pcfsoft" webxr="optionalFeatures: dom-overlay, hit-test; overlayElement: #dom-overlay"
             renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true" background="color: white" >

      <a-assets>
        
        <audio id="snd-murmur" src="../audios/Murmur.mp3" preload="auto"></audio>
        <audio id="snd-door" src="../audios/door.mp3" preload="auto"></audio>
        <audio id="snd-yawn"   src="../audios/Yawn.mp3"   preload="auto"></audio>
        <audio id="snd-laugh"  src="../audios/Laugh.mp3"  preload="auto"></audio>
        <audio id="snd-caugh" src="../audios/cough.wav" preload="auto"></audio>
        <audio id="snd-wthought" src="../audios/WThought.mp3" preload="auto"></audio>
        <audio id="snd-cough" src="../audios/cough2.mp3" preload="auto"></audio>

        <img id="star-texture" src="../images/star.png" alt="star">
        <img id="star-texture-fallback" src="estrellas.png" alt="star">
      </a-assets>
      <a-entity id="world" >
      <a-entity id="contenedor-modelo" position="0 0 -3"></a-entity>
      <a-entity id="static-visitor" ></a-entity>
      <a-entity id="static-visitor2"></a-entity>
      <a-entity id="static-visitor3"></a-entity>
      <a-entity id="static-visitor4"></a-entity>
      
      <a-entity id="static-visitor2_1" ></a-entity>
      <a-entity id="static-visitor2_2" ></a-entity>
      <a-entity id="static-visitor2_3" ></a-entity>
      <a-entity id="static-visitor2_4" ></a-entity>
      <a-entity id="static-visitor2_5" ></a-entity>
      <a-entity id="static-visitor-3" ></a-entity>
      <a-entity id="static-visitor-3_1" ></a-entity>
      <a-entity id="static-visitor-3_2" ></a-entity>
      <a-entity id="static-visitor-3_3" ></a-entity>
      <a-entity id="static-visitor-3_4" ></a-entity>
      <a-entity id="static-visitor-3_5" ></a-entity>


      <a-entity id="fx-murmur" sound="src: #snd-murmur; autoplay: false; loop: false; positional: false; volume: 1.5"></a-entity>
      <a-entity id="fx-door" sound="src: #snd-door; autoplay: false; loop: false; positional: false; volume: 1"></a-entity>
      <a-entity id="fx-yawn"   sound="src: #snd-yawn;   autoplay: false; loop: false; positional: false; volume: 0.8"></a-entity>
      <a-entity id="fx-laugh"  sound="src: #snd-laugh;  autoplay: false; loop: false; positional: false; volume: 0.8"></a-entity>
      <a-entity id="fx-cough" sound="src: #snd-caugh; autoplay: false; loop: false; positional: false; volume: 0.1"></a-entity>
      <a-entity id="fx-wthought" sound="src: #snd-wthought; autoplay: false; loop: false; positional: false; volume: 0.3"></a-entity>
      <a-entity id="fx-cough2" sound="src: #snd-cough; autoplay: false; loop: false; positional: false; volume: 0.5"></a-entity>
      </a-entity>
      <a-entity id="ui-3d-container" position="-1.8 2.8 -2.5">
        <a-rounded id="timer-3d-bg" width="0.6" height="0.16" radius="0.03" color="#FFFFFF" opacity="0.95" 
                 position="0 0.19 0" material="shader: flat">
          <a-text id="timer-3d-text" value="00:00" color="#3b2e6d" align="center" 
                  width="1.2" position="0 0 0.01" font="roboto" letter-spacing="0"></a-text>
      </a-rounded>
        
      <a-rounded id="action-btn-3d" width="0.5" height="0.14" radius="0.025" color="#a48cf0" 
                 position="0 0 0" 
                 class="clickable"
                 material="shader: flat">
        <a-text id="action-btn-text"
                value="INICIAR"
                color="#FFFFFF"
                align="center"
                width="1.0"
                position="0 0 0.03"
                font="roboto"
                letter-spacing="0"></a-text>
      </a-rounded>

      </a-entity>

      <a-entity camera look-controls wasd-controls position="0 1.6 0">
        <a-entity cursor="fuse: true; fuseTimeout: 1000" position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: black; shader: flat"
          raycaster="objects: .clickable">
        </a-entity>
      </a-entity>

      <a-entity id="loading-panel-3d"
                position="0 0 -2"
                visible="false"
                loading-modal-3d
                follow-camera>

        <a-plane width="50" height="50"
                 color="#000000"
                 opacity="0.75" 
                 position="0 0 0"
                 material="shader: flat"></a-plane>

        <a-rounded width="2.0"
                   height="0.8"
                   radius="0.08"
                   color="#FFFFFF"
                   opacity="0.98"
                   position="0 0 0.01"
                   material="shader: flat">
        </a-rounded>
      
        <a-text value="Generando tus resultados,"
                align="center"
                width="1.8"
                color="#4A4A6A"
                position="0 0.2 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                scale="0.9 0.9 1"></a-text>
      
        <a-text value="no salgas de esta vista"
                align="center"
                width="1.8"
                color="#4A4A6A"
                position="0 0 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                scale="0.9 0.9 1"></a-text>
      
        <a-ring radius-inner="0.03"
                radius-outer="0.05"
                color="#f3f3f3"
                position="0 -0.25 0.02"
                material="shader: flat"></a-ring>
      
        <a-ring radius-inner="0.03"
                radius-outer="0.05"
                theta-length="270"
                color="#9b5de5"
                position="0 -0.25 0.03"
                material="shader: flat"
                animation="property: rotation; to: 0 0 360; loop: true; dur: 1000; easing: linear">
          </a-ring>
        </a-entity>
            
        <a-entity id="result-panel-3d"
                  position="0 0 -2"
                  visible="false"
                  result-modal-3d
                  follow-camera>
            
          <a-plane width="50" height="50"
                   color="#000000"
                   opacity="0.75" 
                   position="0 0 0"
                   material="shader: flat"></a-plane>
            
          <a-rounded width="2.4"
                     height="1.6"
                     radius="0.08"
                     color="#FFFFFF"
                     opacity="0.98"
                     position="0 0 0.01"
                     material="shader: flat">
          </a-rounded>
        
          <a-text id="result-title-3d"
                  value="Resultados"
                  align="center"
                  width="2.2"
                  color="#4A4A6A"
                  position="0 0.55 0.02"
                  font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                  scale="1.2 1.2 1"></a-text>
        
          <a-text id="result-message-3d"
                  value=""
                  align="center"
                  width="2.1"
                  color="#4A4A6A"
                  position="0 0.15 0.02"
                  font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                  wrap-count="35"
                  baseline="center"
                  scale="0.9 0.9 1"></a-text>
        
          <a-entity id="result-stars-container-3d" position="0 -0.15 0.02"></a-entity>
        
          <a-rounded id="result-ok-3d"
                     class="clickable"
                     width="0.8"
                     height="0.18"
                     radius="0.04"
                     color="#9b5de5"
                     position="0 -0.55 0.02"
                     material="shader: flat">
            <a-text value="Aceptar"
                    align="center"
                    width="1.6"
                    color="#FFFFFF"
                    position="0 0 0.03"
                    font="roboto"></a-text>
          </a-rounded>
        </a-entity>
      
    </a-scene>
    <script src="./js/assets-manifest.js"></script>
    <script src="./js/assets-loader.js"></script>
    <script src="./js/config.js"></script>
    <script>
      window.SKIP_GLOBAL_BINDINGS = true;
    </script>
    <script src="./js/global.js"></script>
    <script src="./js/easycontroller.js"></script>
    <script src="./js/intercontroller.js"></script>
    <script src="./js/difcontroller.js"></script>
    
    <script>
      function applyHudMobileTuning() {
        if (window.estadoSesion && window.estadoSesion !== 'idle') return;
        const ui   = document.getElementById("ui-3d-container");
        const btn  = document.getElementById("action-btn-3d");
        const text = document.getElementById("action-btn-text");
        const timerBg = document.getElementById("timer-3d-bg");
        const timerTx = document.getElementById("timer-3d-text");
        if (!ui || !btn || !text) return;
      
        const isMobile = window.matchMedia("(max-width: 820px)").matches;
        if (!isMobile) return;
      
        const isLandscape = window.matchMedia("(orientation: landscape)").matches;
        const uiScale = isLandscape ? 1.6 : 1.2;
      
        ui.setAttribute("scale", `${uiScale} ${uiScale} ${uiScale}`);
        ui.setAttribute("position", isLandscape ? "-1 1.6 -2.6" : "-1 2.1 -2.9");
      
        btn.setAttribute("width",  isLandscape ? "1.40" : "1.35");
        btn.setAttribute("height", isLandscape ? "0.25" : "0.20");
        btn.setAttribute("radius", "0.06");
      
        text.setAttribute("width", "2.2");
        text.setAttribute("scale", "1.3 1.3 1");
      
        if (timerBg) {
          timerBg.setAttribute("width",  isLandscape ? "1.20" : "1.05");
          timerBg.setAttribute("height", isLandscape ? "0.30" : "0.26");
          timerBg.setAttribute("radius", "0.06");
        
          const gapY = 0.35;
          timerBg.setAttribute("position", `0 ${gapY} 0`);
          btn.setAttribute("position", "0 0 0");
        }
      
        if (timerTx) {
          timerTx.setAttribute("width", "2.2");
          timerTx.setAttribute("scale", "1.2 1.2 1");
        }
      }
    
      window.addEventListener("load", applyHudMobileTuning);
      window.addEventListener("resize", applyHudMobileTuning);
      window.addEventListener("orientationchange", applyHudMobileTuning);
    </script>

    
    <script>
      AFRAME.registerComponent('follow-camera', {
        init: function () {
          this.camera = document.querySelector('[camera]');
        },
        tick: function () {
          if (this.camera) {
            const cameraPos = this.camera.getAttribute('position');
            const cameraRot = this.camera.getAttribute('rotation');

            this.el.setAttribute('position', {
              x: cameraPos.x,
              y: cameraPos.y,
              z: cameraPos.z - 2 
            });

            this.el.setAttribute('rotation', {
              x: 0,
              y: cameraRot.y,
              z: 0
            });
          }
        }
      });

      AFRAME.registerGeometry('rounded', {
        schema: {
          width: {default: 1, min: 0},
          height: {default: 1, min: 0},
          radius: {default: 0.1, min: 0}
        },
        init: function(data) {
          const w = data.width;
          const h = data.height;
          const r = Math.min(data.radius, Math.min(w, h) / 2);
          
          const shape = new THREE.Shape();
          const x = -w / 2;
          const y = -h / 2;
          
          shape.moveTo(x + r, y);
          shape.lineTo(x + w - r, y);
          shape.quadraticCurveTo(x + w, y, x + w, y + r);
          shape.lineTo(x + w, y + h - r);
          shape.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
          shape.lineTo(x + r, y + h);
          shape.quadraticCurveTo(x, y + h, x, y + h - r);
          shape.lineTo(x, y + r);
          shape.quadraticCurveTo(x, y, x + r, y);
          
          const geometry = new THREE.ShapeGeometry(shape);
          this.geometry = geometry;
        }
      });

      AFRAME.registerPrimitive('a-rounded', {
        defaultComponents: {
          geometry: {primitive: 'rounded'},
          material: {}
        },
        mappings: {
          width: 'geometry.width',
          height: 'geometry.height',
          radius: 'geometry.radius',
          color: 'material.color',
          opacity: 'material.opacity'
        }
      });
    </script>

    <script>
      AFRAME.registerComponent('loading-modal-3d', {
        init: function () {
        },
        show: function () {
          this.el.setAttribute('visible', true);
        },
        hide: function () {
          this.el.setAttribute('visible', false);
        }
      });

      AFRAME.registerComponent('result-modal-3d', {
        init: function () {
          this.titleEl = this.el.querySelector('#result-title-3d');
          this.msgEl = this.el.querySelector('#result-message-3d');
          this.starsContainer = this.el.querySelector('#result-stars-container-3d');
      
          this._armed = false;
          this._lastOk = 0;
          this._armTimer = null;
      
          this.okBtn = this.el.querySelector('#result-ok-3d');
      
          const handler = (ev) => {
            try {
              ev.preventDefault?.();
              ev.stopPropagation?.();
            } catch {}
      
            const now = performance.now();
      
            if (!this._armed) {
              console.warn('[OK] blocked: not armed yet');
              return;
            }
            if (now - this._lastOk < 800) {
              console.warn('[OK] blocked: double tap');
              return;
            }
            this._lastOk = now;
      
            this.hide();
            if (typeof window.onResultOk === 'function') window.onResultOk();
          };
      
          if (this.okBtn) {
            this.okBtn.addEventListener('touchstart', handler, { passive: false });
            this.okBtn.addEventListener('mousedown', handler, { passive: false });
            this.okBtn.addEventListener('click', handler, { passive: false });
          }
        },
      
        show: function (message, stars, title) {
          this.clearStars();
          if (this.titleEl && title) this.titleEl.setAttribute('value', title);
          if (this.msgEl && message) this.msgEl.setAttribute('value', message);
          this.renderStars(stars);
      
          this.el.setAttribute('visible', true);
          setCameraControlsEnabled(false);
      
          this._armed = false;
          if (this._armTimer) clearTimeout(this._armTimer);
      
          if (this.okBtn) this.okBtn.classList.remove('clickable');
      
          this._armTimer = setTimeout(() => {
            this._armed = true;
            if (this.okBtn) this.okBtn.classList.add('clickable');
          }, 1000);
        },
      
        hide: function () {
          this.el.setAttribute('visible', false);
          this._armed = false;
          if (this._armTimer) clearTimeout(this._armTimer);
          this._armTimer = null;
      
          if (this.okBtn) this.okBtn.classList.add('clickable'); // lo dejamos normal
      
          setCameraControlsEnabled(true);
        },
      
        clearStars: function () {
          if (this.starsContainer) this.starsContainer.innerHTML = '';
        },
      
      renderStars: function(stars) {
        if (!this.starsContainer) return;

        let starCount = 0;

        if (typeof stars === "number") {
          starCount = Math.max(0, Math.min(3, stars));
        } else if (typeof stars === "string") {
          starCount = parseInt(stars, 10) || 0;
        }

        starCount = Math.max(0, Math.min(3, starCount));
        console.log("Mostrando estrellas:", starCount);

        if (starCount === 0) {
          this.starsContainer.setAttribute('visible', 'false');
          return;
        }

        this.starsContainer.setAttribute('visible', 'true');
        this.clearStars();

        const starSpacing = 0.3;
        const startX = -((starCount - 1) * starSpacing) / 2;

        for (let i = 0; i < starCount; i++) {
          const star = this.createPurpleStar();
          star.setAttribute('position', {
            x: startX + (i * starSpacing),
            y: -0.15,
            z: 0.02
          });
          this.starsContainer.appendChild(star);
        }
      },

      createPurpleStar: function() {
        const star = document.createElement('a-entity');

        const starShape = new THREE.Shape();
        const spikes = 5;
        const outerRadius = 0.07;
        const innerRadius = 0.035;

        let rot = (Math.PI / 2) * 3;
        starShape.moveTo(0, -outerRadius);

        for (let i = 0; i < spikes; i++) {
          const x1 = Math.cos(rot) * outerRadius;
          const y1 = Math.sin(rot) * outerRadius;
          starShape.lineTo(x1, y1);
          rot += Math.PI / spikes;

          const x2 = Math.cos(rot) * innerRadius;
          const y2 = Math.sin(rot) * innerRadius;
          starShape.lineTo(x2, y2);
          rot += Math.PI / spikes;
        }

        starShape.lineTo(0, -outerRadius);

        const geometry = new THREE.ShapeGeometry(starShape);
        const material = new THREE.MeshBasicMaterial({
          color: 0x7A3FBF,
          transparent: false,
          side: THREE.DoubleSide
        });

        const mesh = new THREE.Mesh(geometry, material);
        mesh.rotation.x = Math.PI;
        mesh.scale.set(1.2, 1.2, 1.2);

        star.object3D.add(mesh);

        return star;
      },

      drawStar: function(ctx, cx, cy, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        let step = Math.PI / spikes;
      
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);
      
        for (let i = 0; i < spikes; i++) {
          x = cx + Math.cos(rot) * outerRadius;
          y = cy + Math.sin(rot) * outerRadius;
          ctx.lineTo(x, y);
          rot += step;
        
          x = cx + Math.cos(rot) * innerRadius;
          y = cy + Math.sin(rot) * innerRadius;
          ctx.lineTo(x, y);
          rot += step;
        }
      
        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();

        ctx.fillStyle = '#9b59b6';
        ctx.fill();

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#8e44ad';
        ctx.stroke();
      },

      drawStar: function(ctx, cx, cy, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        let step = Math.PI / spikes;
      
        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);
      
        for (let i = 0; i < spikes; i++) {
          x = cx + Math.cos(rot) * outerRadius;
          y = cy + Math.sin(rot) * outerRadius;
          ctx.lineTo(x, y);
          rot += step;
        
          x = cx + Math.cos(rot) * innerRadius;
          y = cy + Math.sin(rot) * innerRadius;
          ctx.lineTo(x, y);
          rot += step;
        }
      
        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();
        ctx.fill();
      }
    });

    function setCameraControlsEnabled(enabled) {
      const cam = document.querySelector('[camera]');
      if (!cam || !cam.components) return;
    
      const wasd = cam.components['wasd-controls'];
      if (wasd && wasd.pause && wasd.play) enabled ? wasd.play() : wasd.pause();
    
      const look = cam.components['look-controls'];
      if (look && look.pause && look.play) enabled ? look.play() : look.pause();
    
      const cursorEl = document.querySelector('[cursor]');
      if (cursorEl) {
        cursorEl.setAttribute('visible', enabled);
        cursorEl.setAttribute('raycaster', `objects: ${enabled ? '.clickable' : ''}`);
        cursorEl.setAttribute('cursor', `fuse: ${enabled}; fuseTimeout: 1000`);
      }
    }


    function getCmp(id, name) {
      const el = document.querySelector(id);
      if (!el) return null;
      const cmp = el.components[name];
      return cmp ? cmp : null;
    }

    window.showLoading3D = function () {
      const cmp = getCmp('#loading-panel-3d', 'loading-modal-3d');
      if (cmp) cmp.show();
    
      const timerUI = document.getElementById('ui-3d-container');
      if (timerUI) timerUI.setAttribute('visible', 'false');

      if (typeof stopTimer === 'function') stopTimer();
      if (typeof stopAudioCues === 'function') stopAudioCues();
      if (typeof stopEmojis === 'function') stopEmojis();
      setCameraControlsEnabled(true);
    };

    window.hideLoading3D = function () {
      const cmp = getCmp('#loading-panel-3d', 'loading-modal-3d');
      if (cmp) cmp.hide();
    
      const timerUI = document.getElementById('ui-3d-container');
      if (timerUI) timerUI.setAttribute('visible', 'true');
    };

    window.showResult3D = function (message, stars, title) {
      console.log("showResult3D llamado:", { message, stars, title });
      const cmp = getCmp('#result-panel-3d', 'result-modal-3d');
      if (cmp) cmp.show(message, stars, title);
    
      const timerUI = document.getElementById('ui-3d-container');
      if (timerUI) timerUI.setAttribute('visible', 'false');
    
      if (typeof stopTimer === 'function') stopTimer();
      if (typeof stopAudioCues === 'function') stopAudioCues();
      if (typeof stopEmojis === 'function') stopEmojis();
      setCameraControlsEnabled(false);
    };

    window.hideResult3D = function () {
      const cmp = getCmp('#result-panel-3d', 'result-modal-3d');
      if (cmp) cmp.hide();

      const timerUI = document.getElementById('ui-3d-container');
      if (timerUI) timerUI.setAttribute('visible', 'true');

      setCameraControlsEnabled(true);
    };
  </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const scene = document.querySelector("a-scene");

        if (nivel === "intermedio") {
          console.log("Applying bright lighting for INTERMEDIATE level...");

          const ambient = document.createElement("a-entity");
          ambient.setAttribute("light", {
            type: "ambient",
            color: "#FFFFFF",
            intensity: 1.5        
          });
          scene.appendChild(ambient);

          const sun = document.createElement("a-entity");
          sun.setAttribute("light", {
            type: "directional",
            castShadow: false,
            color: "#FFFFFF",
            intensity: 1.5
          });
          sun.setAttribute("position", "1 4 -2");
          scene.appendChild(sun);

          const fill = document.createElement("a-entity");
          fill.setAttribute("light", {
            type: "hemisphere",
            intensity: 1.4,
            groundColor: "#dddddd",
            color: "#FFFFFF"
          });
          fill.setAttribute("position", "0 3 0");
          scene.appendChild(fill);
        }
      });
      </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const scene = document.querySelector("a-scene");

        if (nivel === "facil") {
          scene.setAttribute("lvl1-visitor-event", "enabled: true");
          scene.setAttribute("lvl2-visitor-event", "enabled: false");
          scene.setAttribute("lvl3-visitor-event", "enabled: false");
          scene.removeAttribute("lvl2-visitor-event");
          scene.removeAttribute("lvl3-visitor-event");
          console.log("Nivel FACIL usando lvl1-visitor-event");
        }
        else if (nivel === "intermedio") {
          scene.setAttribute("lvl2-visitor-event", "enabled: true");
          scene.setAttribute("lvl1-visitor-event", "enabled: false");
          scene.setAttribute("lvl3-visitor-event", "enabled: false");
          scene.removeAttribute("lvl1-visitor-event");
          scene.removeAttribute("lvl3-visitor-event");
          console.log("Nivel INTERMEDIO usando lvl2-visitor-event");
        }
        else if (nivel === "dificil") {
          scene.setAttribute("lvl3-visitor-event", "enabled: true");
          scene.setAttribute("lvl1-visitor-event", "enabled: false");
          scene.setAttribute("lvl2-visitor-event", "enabled: false");
          scene.removeAttribute("lvl1-visitor-event");
          scene.removeAttribute("lvl2-visitor-event");
          console.log("Nivel DIFICIL usando lvl3-visitor-event");
        }
        else {
          console.warn("Nivel desconocido, no se cargaron eventos.");
        }
      });
    </script>
    <script>
      AFRAME.registerComponent('button-3d-handler', {
        init: function() {
          this.el.addEventListener('click', () => {
            const btn3d = document.getElementById('action-btn-3d');
            const btnText = document.getElementById('action-btn-text');
            const currentText = btnText.getAttribute('value');
            
            if (estadoSesion === 'idle') {
              btnText.setAttribute('value', 'Iniciando...');
              btn3d.setAttribute('color', '#9b7dd4');
              
              startImmersion()
                .then(() => {
                  btnText.setAttribute('value', 'ENVIAR');
                  btn3d.setAttribute('color', '#a48cf0');
                  if (typeof startCountdown === 'function') startCountdown();
                })
                .catch((err) => {
                  console.error(err);
                  btnText.setAttribute('value', 'INICIAR');
                  btn3d.setAttribute('color', '#a48cf0');
                });
            } else if (estadoSesion === 'recording') {
              let elapsed = 0;
              if (window.initialSeconds !== undefined && window.countdownSeconds !== undefined) {
                elapsed = Math.max(0, window.initialSeconds - window.countdownSeconds);
              } else {
                elapsed = segundosTranscurridos;
              }
              
              const debeSubir = elapsed >= 30;
              
              if (typeof window.finalizarSesionWrapper === 'function') {
                window.finalizarSesionWrapper(debeSubir);
              } else {
                if (typeof stopTimer === 'function') stopTimer();
                finalizarSesion(debeSubir);
              }
            }
          });
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          const btn3d = document.getElementById('action-btn-3d');
          if (btn3d) {
            btn3d.setAttribute('button-3d-handler', '');
          }
        }, 500);
      });

      let timerInterval;
      let isTimerRunning = false;
      let countdownSeconds = 0;
      let initialSeconds = 0;

      window.countdownSeconds = countdownSeconds;
      window.initialSeconds = initialSeconds;

      let timerText3d;
      let actionBtn3d;
      let actionBtnText;

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }

      function updateTimer() {
        if (countdownSeconds > 0) {
          countdownSeconds--;
          const formatted = formatTime(countdownSeconds);
          if (timerText3d) timerText3d.setAttribute('value', formatted);
          window.countdownSeconds = countdownSeconds;
          window.initialSeconds = initialSeconds;
          if (window.segundosTranscurridos !== undefined) {
            window.segundosTranscurridos = initialSeconds - countdownSeconds;
          }
        } else {
          if (typeof stopEmojis === 'function') stopEmojis();
          if (typeof stopAudioCues === 'function') stopAudioCues();
          if (typeof stopTimer === 'function') stopTimer();
          if (typeof finalizarSesion === 'function') finalizarSesion(true);
        }
      }

      function startCountdown() {
        if (!isTimerRunning) {
          const minutos = parseInt(localStorage.getItem('tiempoSeleccionado'), 10) || 1;
          countdownSeconds = minutos * 60;
          initialSeconds = countdownSeconds;
          window.countdownSeconds = countdownSeconds;
          window.initialSeconds = initialSeconds;
        
          if (timerText3d) timerText3d.setAttribute('value', formatTime(countdownSeconds));
          timerInterval = setInterval(updateTimer, 1000);
          isTimerRunning = true;
          if (actionBtnText) actionBtnText.setAttribute('value', 'ENVIAR');
        
          if (typeof startAudioCues === 'function') startAudioCues();
          if (typeof startEmojis === 'function') startEmojis();
          window.visitorEventEnabled = true;  
        }
      }

      function stopTimer() {
        if (isTimerRunning) {
          clearInterval(timerInterval);
          isTimerRunning = false;
          window.visitorEventEnabled = false;
        }
      }

      function showInitialTime() {
        const minutos = parseInt(localStorage.getItem('tiempoSeleccionado'), 10) || 1;
        countdownSeconds = minutos * 60;
        if (timerText3d) timerText3d.setAttribute('value', formatTime(countdownSeconds));
        if (actionBtnText) actionBtnText.setAttribute('value', 'INICIAR');
      }

      function resetTimer() {
        stopTimer();
        countdownSeconds = 0;
        if (timerText3d) timerText3d.setAttribute('value', '00:00');
        if (actionBtnText) actionBtnText.setAttribute('value', 'INICIAR');
      }

      window.addEventListener('load', () => {
        timerText3d  = document.getElementById('timer-3d-text');
        actionBtn3d  = document.getElementById('action-btn-3d');
        actionBtnText = document.getElementById('action-btn-text');
      
        if (actionBtn3d && !actionBtn3d.hasAttribute('button-3d-handler')) {
          actionBtn3d.setAttribute('button-3d-handler', '');
        }
      
        setTimeout(showInitialTime, 100);
      });


      const sceneEl = document.querySelector('#escena-vr');
      const fxMurmurEl = document.querySelector('#fx-murmur');
      const fxLaughEl  = document.querySelector('#fx-laugh');

      function comp(el){ return el?.components?.sound ?? null; }

      const PH2_MIN_GAP = 10, PH2_MAX_GAP = 20;
      let audioUnlocked = false;
      let runningPhase2 = false;
      let scheduledTimers = [];
      let phase2Timer = null;
      let lastCueAt = -Infinity;
      const MIN_SEP_MS = 4000;

      const NAME_MAP = { 'fx-murmur':'Murmur', 'fx-laugh':'Laugh' };
      function logCue(el){
        const name = NAME_MAP[el.id] || el.id;
        const t = new Date().toLocaleTimeString();
        const remaining = typeof window.countdownSeconds === 'number' ? window.countdownSeconds : 0;
        console.log(`[AudioCue] ${name} @ ${t} | restante: ${formatTime(Math.max(0, remaining))}`);
      }

      async function unlockAudio() {
        try {
          const ctx = AFRAME.audioContext;
          if (ctx && ctx.state !== 'running') await ctx.resume();
          for (const id of ['snd-murmur','snd-yawn','snd-laugh']) {
            const el = document.getElementById(id);
            try { const v=el.volume; el.volume=0; await el.play(); el.pause(); el.currentTime=0; el.volume=v; } catch {}
          }
          audioUnlocked = true;
        } catch(e){ console.warn('[Audio] unlock fail', e); }
      }

      function now(){ return performance.now(); }

      function playEl(el){
        if(!el) return;
        const c = comp(el);
        if (!c) { el.addEventListener('sound-loaded', ()=>playEl(el), {once:true}); return; }
        const t = now();
        if (t - lastCueAt < MIN_SEP_MS) {
          const id = setTimeout(()=>playEl(el), MIN_SEP_MS - (t - lastCueAt) + 50);
          scheduledTimers.push(id);
          return;
        }
        lastCueAt = t;
        c.stopSound();
        c.playSound();
        logCue(el);
        triggerEmojiBurst(el.id);
      }

      function clearScheduled(){
        for (const id of scheduledTimers) clearTimeout(id);
        scheduledTimers = [];
        if (phase2Timer) { clearTimeout(phase2Timer); phase2Timer = null; }
      }

      function schedulePhase1(){
        const D = window.initialSeconds || 60;
        const startFrac = 0.20, endFrac = 0.85;
        const ids = shuffle(['fx-murmur','fx-laugh']);
        const bins = ids.length;
        for (let i=0;i<bins;i++){
          const centerFrac = startFrac + (i + 0.5) * ((endFrac - startFrac) / bins);
          const jitter = (Math.random()*0.14 - 0.07);
          const whenS = Math.max(0, Math.min(1, centerFrac + jitter)) * D;
          const delayMs = Math.max(0, Math.round(whenS*1000));
          const el = document.getElementById(ids[i]);
          const tid = setTimeout(()=>playEl(el), delayMs);
          scheduledTimers.push(tid);
        }
        const phase2StartMs = Math.round((endFrac*D)*1000) + 500;
        const ph2Tid = setTimeout(()=>startPhase2(), phase2StartMs);
        scheduledTimers.push(ph2Tid);
      }

      function startPhase2(){
        runningPhase2 = true;
        scheduleNextPhase2();
      }
      function scheduleNextPhase2(){
        if (!runningPhase2) return;
        const gap = PH2_MIN_GAP + Math.random()*(PH2_MAX_GAP - PH2_MIN_GAP);
        phase2Timer = setTimeout(()=>{
          const pick = Math.random();
          const el = pick < 1/2 ? fxMurmurEl : fxLaughEl;
          playEl(el);
          scheduleNextPhase2();
        }, gap*1000);
      }

      function stopAudioCues(){
        runningPhase2 = false;
        clearScheduled();
        for (const el of [fxMurmurEl, fxLaughEl]) {
          const c = comp(el); if (c?.isPlaying) c.stopSound();
        }
      }

      function shuffle(arr){
        for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
        return arr;
      }

      async function startAudioCues(){
        await unlockAudio();
        stopAudioCues(); 
        lastCueAt = -Infinity;
        schedulePhase1();
      }

      sceneEl.addEventListener('enter-vr', () => { if (isTimerRunning) { startAudioCues(); startEmojis(); } });
      sceneEl.addEventListener('exit-vr',  () => { stopEmojis(); stopAudioCues(); });
      sceneEl.addEventListener('enter-ar', () => { if (isTimerRunning) { startAudioCues(); startEmojis(); } });
      sceneEl.addEventListener('exit-ar',  () => { stopEmojis(); stopAudioCues(); });

      function computeXRANGE() {
        const ar = Math.max(1, window.innerWidth / Math.max(1, window.innerHeight));
        return Math.min(4.4, Math.max(2.4, 2.6 * ar)); 
      }

      let X_RANGE = computeXRANGE();     
      const Y_MIN_BAND = 0.20;           
      const Y_MAX_BAND = 1.25;           
      const EDGE_BIAS   = 0.6;           
      const EDGE_PAD    = 0.25;          
      const EMOJI_DIST_Z = -1.4;

      const EMOJI_SIZE_MIN = 0.09;
      const EMOJI_SIZE_MAX = 0.14;
      const MIN_SEPARATION = 0.25;
      const MAX_ONSCREEN   = 6;
      const LIFE_MS        = 2500;
      const BG_MIN_GAP_MS  = 6000;
      const BG_MAX_GAP_MS  = 11000;

      let emojiInterval = null;
      const ACTIVE_EMOJIS = new Set();

      const EMOJIS_RANDOM = ["üòÑ","üò¢","üò†","üòê","üòÇ","ü§î","ü•±","üò≥","üòé","ü§Ø"];

      function getCameraEl() {
        const scene = document.querySelector('a-scene');
        return scene?.camera?.el || scene?.querySelector('[camera]');
      }

      function emojiCanvas(face, sizePx = 256) {
        const c = document.createElement('canvas');
        c.width = c.height = sizePx;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, sizePx, sizePx);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.floor(sizePx*0.82)}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","EmojiOne Color","Twemoji Mozilla",sans-serif`;
        ctx.fillText(face, sizePx/2, sizePx/2);
        return c;
      }

      function sampleX() {
        const half = X_RANGE / 2;
        if (Math.random() < EDGE_BIAS) {
          const sign = Math.random() < 0.5 ? -1 : 1;
          return sign * (half - EDGE_PAD - Math.random() * 0.6); 
        }
        return (Math.random() - 0.5) * (X_RANGE * 0.65);
      }
      function sampleY() {
        return Y_MIN_BAND + Math.random() * (Y_MAX_BAND - Y_MIN_BAND);
      }

      function findFreePosition(size) {
        const halfDiag = Math.hypot(size, size) / 2;
        for (let tries = 0; tries < 18; tries++) {
          const x = sampleX();
          const y = sampleY();
          let ok = true;
          for (const meta of ACTIVE_EMOJIS) {
            const dx = x - meta.x, dy = y - meta.y;
            if (Math.hypot(dx, dy) < (MIN_SEPARATION + halfDiag + meta.halfDiag)) { ok = false; break; }
          }
          if (ok) return { x, y };
        }
        return { x: sampleX(), y: sampleY() };
      }

      async function spawnEmoji(face) {
        const camEl = getCameraEl();
        if (!camEl) return;
        if (ACTIVE_EMOJIS.size >= MAX_ONSCREEN) return;
      
        const chosen = face || EMOJIS_RANDOM[Math.floor(Math.random() * EMOJIS_RANDOM.length)];
        const size = EMOJI_SIZE_MIN + Math.random() * (EMOJI_SIZE_MAX - EMOJI_SIZE_MIN);
        const { x, y } = findFreePosition(size);
      
        const canvas = emojiCanvas(chosen, 256);
        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true;
      
        const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 1, depthTest: true });
        const sprite = new THREE.Sprite(mat);
      
        sprite.scale.set(size, size, 1);
        sprite.position.set(x, y, EMOJI_DIST_Z);
      
        camEl.object3D.add(sprite);
      
        const meta = { el: sprite, x, y, halfDiag: Math.hypot(size, size)/2, _tex: tex, _mat: mat };
        ACTIVE_EMOJIS.add(meta);
      
        console.log(`[Emojis] ${chosen} | pos=(${x.toFixed(2)},${y.toFixed(2)})`);
      
        const start = performance.now();
        const dur = LIFE_MS;
        function tick(t) {
          const k = Math.min(1, (t - start) / dur);
          mat.opacity = 1 - k;
          if (k < 1 && sprite.parent) requestAnimationFrame(tick);
          else {
            if (sprite.parent) camEl.object3D.remove(sprite);
            tex.dispose(); mat.dispose();
            ACTIVE_EMOJIS.delete(meta);
          }
        }
        requestAnimationFrame(tick);
      }

      function startEmojis() {
        stopEmojis();
        X_RANGE = computeXRANGE();
        spawnEmoji();
        const gap = BG_MIN_GAP_MS + Math.random() * (BG_MAX_GAP_MS - BG_MIN_GAP_MS);
        emojiInterval = setInterval(() => spawnEmoji(), gap);
        console.log(`[Emojis] ON | X_RANGE=${X_RANGE.toFixed(2)}, Y=[${Y_MIN_BAND},${Y_MAX_BAND}]`);
      }

      function stopEmojis() {
        if (emojiInterval) { clearInterval(emojiInterval); emojiInterval = null; }
        for (const meta of Array.from(ACTIVE_EMOJIS)) {
          if (meta.el && meta.el.parent) meta.el.parent.remove(meta.el);
          if (meta._tex) meta._tex.dispose();
          if (meta._mat) meta._mat.dispose();
          ACTIVE_EMOJIS.delete(meta);
        }
        console.log('[Emojis] OFF');
      }

      window.addEventListener('resize', () => { X_RANGE = computeXRANGE(); });
      
    </script>
    <script>
      function getNivel() {
        const params = new URLSearchParams(window.location.search);
        return params.get("nivel")?.toLowerCase() || "facil";
      }
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const v1 = document.querySelector("#static-visitor");
        const v2 = document.querySelector("#static-visitor2");
        const v3 = document.querySelector("#static-visitor2_1");
        const v4 = document.querySelector("#static-visitor2_2");
        const v5 = document.querySelector("#static-visitor2_3");
        const v6 = document.querySelector("#static-visitor2_4");
        const v7 = document.querySelector("#static-visitor2_5");
        const v8 = document.querySelector("#static-visitor4");
        const v9 = document.querySelector("#static-visitor-3");
        const v10 = document.querySelector("#static-visitor-3_1");
        const v11 = document.querySelector("#static-visitor-3_2");
        const v12 = document.querySelector("#static-visitor-3_3");
        const v13 = document.querySelector("#static-visitor-3_4");
        const v14 = document.querySelector("#static-visitor-3_5");

        if (nivel === "facil") {
          if (v3) v3.setAttribute("visible", false); 
          if (v4) v4.setAttribute("visible", false);
          if (v5) v5.setAttribute("visible", false);
          if (v6) v6.setAttribute("visible", false);
          if (v7) v7.setAttribute("visible", false);
          if (v9) v9.setAttribute("visible", false);
          if (v10) v10.setAttribute("visible", false);
          if (v11) v11.setAttribute("visible", false);
          if (v12) v12.setAttribute("visible", false);
          if (v13) v13.setAttribute("visible", false);
          if (v14) v14.setAttribute("visible", false);
        }
        else if(nivel === "intermedio") {
          if (v1) v1.setAttribute("visible", false);
          if (v2) v2.setAttribute("visible", false);
          if (v8) v8.setAttribute("visible", false);
          if (v9) v9.setAttribute("visible", false);
          if (v10) v10.setAttribute("visible", false);
          if (v11) v11.setAttribute("visible", false);
          if (v12) v12.setAttribute("visible", false);
          if (v13) v13.setAttribute("visible", false);
          if (v14) v14.setAttribute("visible", false);
        }
        else if (nivel === "dificil"){
          if (v1) v1.setAttribute("visible", false);
          if (v2) v2.setAttribute("visible", false);
          if (v3) v3.setAttribute("visible", false); 
          if (v4) v4.setAttribute("visible", false);
          if (v5) v5.setAttribute("visible", false);
          if (v6) v6.setAttribute("visible", false);
          if (v7) v7.setAttribute("visible", false);
          if (v8) v8.setAttribute("visible", false);
        }
      });
    </script>
    <script>
    function safeShowScene() {
      const scene  = document.querySelector("#escena-vr");
      const loader = document.querySelector("#loader");

      if (scene) scene.style.opacity = "1";

      if (loader) {
        loader.style.opacity = "0";
        setTimeout(() => loader.remove(), 800);
      }
    }

    </script>
  </body>
</html>
