<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Selector de Escenario VR</title>
    <meta name="description" content="WebXR VR Level Selector">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="../styles/game.css" />
  </head>

  <body>
  <div id="loader"
      style="
          position:fixed; inset:0;
          background:white;
          z-index:9999;
          opacity:1;
          display:flex;
          justify-content:center;
          align-items:center;
          flex-direction:column;
          transition: opacity 0.8s ease-in-out;
          ">

    <div class="spinner"
        style="
          width:65px;
          height:65px;
          border:6px solid #e1e1e1;
          border-top:6px solid #9b59b6;
          border-radius:50%;
          animation:spin 1s linear infinite;">
    </div>
    <p style="
          margin-top:18px;
          font-size:18px;
          color:#4b3b74;
          font-weight:600;
       ">
      Cargando inmersi√≥n...
    </p>
  </div>  

    <div id="dom-overlay" style="position:fixed; inset:0; pointer-events:none;  z-index:10000">
      <div class="top-left-container" style="pointer-events:auto">
        <div id="timer-display">00:00</div>
        <button id="action-btn">INICIAR</button>
      </div>

      <div id="loading-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
           background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center; pointer-events:auto;">
        <div style="background:white; padding:60px 80px; border-radius:20px; text-align:center; max-width:500px;">
          <h2 style="margin:0 0 20px; color:#333; font-size:28px;">Generando tus resultados,<br>no salgas de esta vista</h2>
          <div class="spinner" style="margin:30px auto; width:60px; height:60px; border:6px solid #f3f3f3;
               border-top:6px solid #9b59b6; border-radius:50%; animation:spin 1s linear infinite;"></div>
          <style>@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
        </div>
      </div>

      <div id="result-modal" class="result-overlay" style="display:none; pointer-events:auto;">
        <div class="result-card">
          <h3 class="result-title">Resultados</h3>
          <p id="result-message" class="result-text">¬°Buen trabajo! Sigue intent√°ndolo.</p>
          <div id="result-stars" class="result-stars"></div>
          <button id="result-ok" class="result-ok">Aceptar</button>
        </div>
      </div>
    </div>

    <a-scene lvl1-visitor-event="enabled: false" lvl2-visitor-event="enabled: false" lvl3-visitor-event="enabled: false" id="escena-vr" vr-mode-ui="enabled: true" shadow="type: pcfsoft" webxr="optionalFeatures: dom-overlay, hit-test; overlayElement: #dom-overlay"
             renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true" background="color: white" >

      <a-assets>
        <a-asset-item id="modelo-facil" src="../models/facil/easy-scenario2.glb"></a-asset-item>
        <a-asset-item id="modelo-inter" src="../models/inter/classmedium.glb"></a-asset-item>
        <a-asset-item id="modelo-dificil" src="../models/dif/lecturehall.glb"></a-asset-item>
        
        <a-asset-item id="lvl1-visitor" src="../models/people/m1sitted.glb" ></a-asset-item>
        <a-asset-item id="lvl1-visitor2" src="../models/people/p1.glb" ></a-asset-item>
        <a-asset-item id="lvl1-visitor3" src="../models/people/exit.glb" ></a-asset-item>
        <a-asset-item id="lvl1-visitor4" src="../models/people/womanclapping.glb" ></a-asset-item>
        
        <a-asset-item id="lvl2-visitor" src="../models/people/mansitted.glb" ></a-asset-item>
        <a-asset-item id="lvl2-visitor2" src="../models/people/p12bored.glb" ></a-asset-item>
        <a-asset-item id="lvl2-visitor3" src="../models/people/p9.glb" ></a-asset-item>
        <a-asset-item id="lvl2-visitor4" src="../models/people/exit.glb" ></a-asset-item>
        <a-asset-item id="lvl2-visitor5" src="../models/people/p5.glb" ></a-asset-item>

        <a-asset-item id="lvl3-visitor" src="../models/people/mansitted.glb" ></a-asset-item>
        <a-asset-item id="lvl3-visitor-1" src="../models/people/womanclapping.glb" ></a-asset-item>
        <a-asset-item id="lvl3-visitor-2" src="../models/people/p12bored.glb" ></a-asset-item>
        <a-asset-item id="lvl3-visitor-3" src="../models/people/p5.glb" ></a-asset-item>
        <a-asset-item id="lvl3-visitor-4" src="../models/people/p9.glb" ></a-asset-item>
        <a-asset-item id="lvl3-visitor-5" src="../models/people/m1sitted.glb"></a-asset-item>

        <audio id="snd-murmur" src="../audios/Murmur.mp3" preload="auto"></audio>
        <audio id="snd-door" src="../audios/door.mp3" preload="auto"></audio>
        <audio id="snd-yawn"   src="../audios/Yawn.mp3"   preload="auto"></audio>
        <audio id="snd-laugh"  src="../audios/Laugh.mp3"  preload="auto"></audio>
        <audio id="snd-caugh" src="../audios/cough.wav" preload="auto"></audio>
        <audio id="snd-wthought" src="../audios/WThought.mp3" preload="auto"></audio>
        <audio id="snd-cough" src="../audios/cough2.mp3" preload="auto"></audio>
      </a-assets>

      <a-entity id="contenedor-modelo" position="0 0 -3"></a-entity>
      <a-entity id="static-visitor" gltf-model="#lvl1-visitor" idle-pose position="-15 -9 -35" scale="4.5 4 4.5"></a-entity>
      <a-entity id="static-visitor2" gltf-model="#lvl1-visitor2" idle-pose position="-21 -9 -20" scale="3 3 3"></a-entity>
      <a-entity id="static-visitor3" gltf-model="#lvl1-visitor3" idle-pose visible="false" rotation="0 90 0" position="-30 -8 -50" scale="7 7 7"></a-entity>
      <a-entity id="static-visitor4" gltf-model="#lvl1-visitor4" idle-pose position="8 -9.5 -53" scale="9 9 9"></a-entity>
      
      <a-entity id="static-visitor2_1" gltf-model="#lvl2-visitor" idle-pose fix-mixamo-shine position="-62 -20 -95" scale="20 17 19"></a-entity>
      <a-entity id="static-visitor2_2" gltf-model="#lvl2-visitor2" idle-pose position="-60 -20 -50" scale="5.5 5.5 5.5"></a-entity>
      <a-entity id="static-visitor2_3" gltf-model="#lvl2-visitor3" idle-pose position="13.5 -20 -14" scale="6 6 6"></a-entity>
      <a-entity id="static-visitor2_4" gltf-model="#lvl2-visitor4" visible="false"  idle-pose fix-mixamo-shine rotation="0 90 0" position="-80 -22 -20" scale="19 19 19"></a-entity>
      <a-entity id="static-visitor2_5" gltf-model="#lvl2-visitor5" idle-pose position="-64 -22 -75" scale="6 6 6"></a-entity>

      <a-entity id="static-visitor-3" gltf-model="#lvl3-visitor" idle-pose position="-13 2.6 -25" scale="2 2 2"></a-entity>
      <a-entity id="static-visitor-3_1" gltf-model="#lvl3-visitor-1" idle-pose position="-20 0.3 -15" scale="2 2 2"></a-entity>
      <a-entity id="static-visitor-3_2" gltf-model="#lvl3-visitor-2" idle-pose position="-3.4 -1.8 -2" scale="0.5 0.5 0.5"></a-entity>
      <a-entity id="static-visitor-3_3" gltf-model="#lvl3-visitor-3" idle-pose position="-10 -5 -20" scale="5 5 5"></a-entity>
      <a-entity id="static-visitor-3_4" gltf-model="#lvl3-visitor-4" idle-pose position="7 -1.8 -5" scale="0.6 0.6 0.6"></a-entity>
      <a-entity id="static-visitor-3_5" gltf-model="#lvl3-visitor-5" idle-pose position="-1.7 0.4 -15.6" scale="1 1 1"></a-entity>

      <a-entity id="fx-murmur" sound="src: #snd-murmur; autoplay: false; loop: false; positional: false; volume: 5"></a-entity>
      <a-entity id="fx-door" sound="src: #snd-door; autoplay: false; loop: false; positional: false; volume: 1"></a-entity>
      <a-entity id="fx-yawn"   sound="src: #snd-yawn;   autoplay: false; loop: false; positional: false; volume: 0.8"></a-entity>
      <a-entity id="fx-laugh"  sound="src: #snd-laugh;  autoplay: false; loop: false; positional: false; volume: "></a-entity>
      <a-entity id="fx-cough" sound="src: #snd-caugh; autoplay: false; loop: false; positional: false; volume: 0.1"></a-entity>
      <a-entity id="fx-wthought" sound="src: #snd-wthought; autoplay: false; loop: false; positional: false; volume: 0.3"></a-entity>
      <a-entity id="fx-cough2" sound="src: #snd-cough; autoplay: false; loop: false; positional: false; volume: 0.5"></a-entity>
      <a-entity id="visitor-container"></a-entity>

      <a-entity camera look-controls wasd-controls position="0 1.6 0">
        <a-entity cursor="fuse: true; fuseTimeout: 1000" position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: black; shader: flat">
        </a-entity>
      </a-entity>
    </a-scene>

    <script src="./js/config.js"></script>
    <script src="./js/global.js"></script>
    <script src="./js/easycontroller.js"></script>
    <script src="./js/intercontroller.js"></script>
    <script src="./js/difcontroller.js"></script>
    
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const scene = document.querySelector("a-scene");

        if (nivel === "intermedio") {
          console.log("üí° Applying bright lighting for INTERMEDIATE level...");

          const ambient = document.createElement("a-entity");
          ambient.setAttribute("light", {
            type: "ambient",
            color: "#FFFFFF",
            intensity: 1.5        
          });
          scene.appendChild(ambient);

          const sun = document.createElement("a-entity");
          sun.setAttribute("light", {
            type: "directional",
            castShadow: false,
            color: "#FFFFFF",
            intensity: 1.5
          });
          sun.setAttribute("position", "1 4 -2");
          scene.appendChild(sun);

          const fill = document.createElement("a-entity");
          fill.setAttribute("light", {
            type: "hemisphere",
            intensity: 1.4,
            groundColor: "#dddddd",
            color: "#FFFFFF"
          });
          fill.setAttribute("position", "0 3 0");
          scene.appendChild(fill);
        }
      });
      </script>


    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const scene = document.querySelector("a-scene");

        if (nivel === "facil") {
          scene.setAttribute("lvl1-visitor-event", "enabled: true");
          scene.setAttribute("lvl2-visitor-event", "enabled: false");
          scene.setAttribute("lvl3-visitor-event", "enabled: false");
          scene.removeAttribute("lvl2-visitor-event");
          scene.removeAttribute("lvl3-visitor-event");
          console.log("üéÆ Nivel FACIL ‚Üí usando lvl1-visitor-event");
        }
        else if (nivel === "intermedio") {
          scene.setAttribute("lvl2-visitor-event", "enabled: true");
          scene.setAttribute("lvl1-visitor-event", "enabled: false");
          scene.setAttribute("lvl3-visitor-event", "enabled: false");
          scene.removeAttribute("lvl1-visitor-event");
          scene.removeAttribute("lvl3-visitor-event");
          console.log("üéÆ Nivel INTERMEDIO ‚Üí usando lvl2-visitor-event");
        }
        else if (nivel === "dificil") {
          scene.setAttribute("lvl3-visitor-event", "enabled: true");
          scene.setAttribute("lvl1-visitor-event", "enabled: false");
          scene.setAttribute("lvl2-visitor-event", "enabled: false");
          scene.removeAttribute("lvl1-visitor-event");
          scene.removeAttribute("lvl2-visitor-event");
          console.log("üéÆ Nivel DIFICIL ‚Üí usando lvl3-visitor-event");
        }
        else {
          console.warn("‚ö† Nivel desconocido, no se cargaron eventos.");
        }
      });
    </script>


    <script>
      let timerInterval;
      let isTimerRunning = false;
      let countdownSeconds = 0;
      let initialSeconds = 0;

      window.countdownSeconds = countdownSeconds;
      window.initialSeconds = initialSeconds;

      const timerDisplay = document.getElementById('timer-display');
      const actionBtn = document.getElementById('action-btn');

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }

      function updateTimer() {
        if (countdownSeconds > 0) {
          countdownSeconds--;
          timerDisplay.textContent = formatTime(countdownSeconds);
          window.countdownSeconds = countdownSeconds;
          window.initialSeconds = initialSeconds;
          if (window.segundosTranscurridos !== undefined) {
            window.segundosTranscurridos = initialSeconds - countdownSeconds;
          }
        } else {
          stopEmojis();
          stopAudioCues();
          stopTimer();
          if (typeof finalizarSesion === 'function') finalizarSesion(true);
        }
      }

      function startCountdown() {
        if (!isTimerRunning) {
          const minutos = parseInt(localStorage.getItem('tiempoSeleccionado'), 10) || 1;
          countdownSeconds = minutos * 60;
          initialSeconds = countdownSeconds;
          window.countdownSeconds = countdownSeconds;
          window.initialSeconds = initialSeconds;

          timerDisplay.textContent = formatTime(countdownSeconds);
          timerInterval = setInterval(updateTimer, 1000);
          isTimerRunning = true;
          actionBtn.textContent = 'ENVIAR';

          startAudioCues();
          startEmojis();
        }
      }

      function stopTimer() {
        if (isTimerRunning) { clearInterval(timerInterval); isTimerRunning = false; }
      }

      function showInitialTime() {
        const minutos = parseInt(localStorage.getItem('tiempoSeleccionado'), 10) || 1;
        countdownSeconds = minutos * 60;
        timerDisplay.textContent = formatTime(countdownSeconds);
        actionBtn.textContent = 'INICIAR';
        actionBtn.disabled = false;
      }

      function resetTimer() {
        stopTimer();
        countdownSeconds = 0;
        timerDisplay.textContent = '00:00';
        actionBtn.textContent = 'INICIAR';
        actionBtn.disabled = false;
      }

      window.finalizarSesionWrapper = function (subir) {
        window.visitorEventEnabled = false;

        if (typeof stopEmojis === 'function') stopEmojis();
        if (typeof stopAudioCues === 'function') stopAudioCues();
        if (typeof stopTimer === 'function') stopTimer();

        if (typeof finalizarSesion === 'function') finalizarSesion(subir);
      };


      window.addEventListener('load', showInitialTime);
      document.addEventListener('DOMContentLoaded', showInitialTime);

      const sceneEl = document.querySelector('#escena-vr');
      const fxMurmurEl = document.querySelector('#fx-murmur');
      const fxLaughEl  = document.querySelector('#fx-laugh');

      function comp(el){ return el?.components?.sound ?? null; }

      const PH2_MIN_GAP = 10, PH2_MAX_GAP = 20;
      let audioUnlocked = false;
      let runningPhase2 = false;
      let scheduledTimers = [];
      let phase2Timer = null;
      let lastCueAt = -Infinity;
      const MIN_SEP_MS = 4000;

      const NAME_MAP = { 'fx-murmur':'Murmur', 'fx-laugh':'Laugh' };
      function logCue(el){
        const name = NAME_MAP[el.id] || el.id;
        const t = new Date().toLocaleTimeString();
        const remaining = typeof window.countdownSeconds === 'number' ? window.countdownSeconds : 0;
        console.log(`[AudioCue] ${name} @ ${t} | restante: ${formatTime(Math.max(0, remaining))}`);
      }

      async function unlockAudio() {
        try {
          const ctx = AFRAME.audioContext;
          if (ctx && ctx.state !== 'running') await ctx.resume();
          for (const id of ['snd-murmur','snd-yawn','snd-laugh']) {
            const el = document.getElementById(id);
            try { const v=el.volume; el.volume=0; await el.play(); el.pause(); el.currentTime=0; el.volume=v; } catch {}
          }
          audioUnlocked = true;
        } catch(e){ console.warn('[Audio] unlock fail', e); }
      }

      function now(){ return performance.now(); }

      function playEl(el){
        const c = comp(el);
        if (!c) { el.addEventListener('sound-loaded', ()=>playEl(el), {once:true}); return; }
        const t = now();
        if (t - lastCueAt < MIN_SEP_MS) {
          const id = setTimeout(()=>playEl(el), MIN_SEP_MS - (t - lastCueAt) + 50);
          scheduledTimers.push(id);
          return;
        }
        lastCueAt = t;
        c.stopSound();
        c.playSound();
        logCue(el);
        triggerEmojiBurst(el.id);
      }

      function clearScheduled(){
        for (const id of scheduledTimers) clearTimeout(id);
        scheduledTimers = [];
        if (phase2Timer) { clearTimeout(phase2Timer); phase2Timer = null; }
      }

      function schedulePhase1(){
        const D = window.initialSeconds || 60;
        const startFrac = 0.20, endFrac = 0.85;
        const bins = 3;
        const ids = shuffle(['fx-murmur','fx-laugh']);
        for (let i=0;i<bins;i++){
          const centerFrac = startFrac + (i + 0.5) * ((endFrac - startFrac) / bins);
          const jitter = (Math.random()*0.14 - 0.07);
          const whenS = Math.max(0, Math.min(1, centerFrac + jitter)) * D;
          const delayMs = Math.max(0, Math.round(whenS*1000));
          const el = document.getElementById(ids[i]);
          const tid = setTimeout(()=>playEl(el), delayMs);
          scheduledTimers.push(tid);
        }
        const phase2StartMs = Math.round((endFrac*D)*1000) + 500;
        const ph2Tid = setTimeout(()=>startPhase2(), phase2StartMs);
        scheduledTimers.push(ph2Tid);
      }

      function startPhase2(){
        runningPhase2 = true;
        scheduleNextPhase2();
      }
      function scheduleNextPhase2(){
        if (!runningPhase2) return;
        const gap = PH2_MIN_GAP + Math.random()*(PH2_MAX_GAP - PH2_MIN_GAP);
        phase2Timer = setTimeout(()=>{
          const pick = Math.random();
          const el = pick < 1/2 ? fxMurmurEl : fxLaughEl;
          playEl(el);
          scheduleNextPhase2();
        }, gap*1000);
      }

      function stopAudioCues(){
        runningPhase2 = false;
        clearScheduled();
        for (const el of [fxMurmurEl, fxLaughEl]) {
          const c = comp(el); if (c?.isPlaying) c.stopSound();
        }
      }

      function shuffle(arr){
        for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
        return arr;
      }

      async function startAudioCues(){
        await unlockAudio();
        stopAudioCues(); 
        lastCueAt = -Infinity;
        schedulePhase1();
      }

      actionBtn.addEventListener('click', () => {
        if (actionBtn.textContent === 'INICIAR') {
          window.visitorEventEnabled = true;
        } 
        if (actionBtn.textContent === 'ENVIAR') {
          stopEmojis();
          stopAudioCues();
        }
      });

      sceneEl.addEventListener('enter-vr', () => { if (isTimerRunning) { startAudioCues(); startEmojis(); } });
      sceneEl.addEventListener('exit-vr',  () => { stopEmojis(); stopAudioCues(); });
      sceneEl.addEventListener('enter-ar', () => { if (isTimerRunning) { startAudioCues(); startEmojis(); } });
      sceneEl.addEventListener('exit-ar',  () => { stopEmojis(); stopAudioCues(); });

      function computeXRANGE() {
        const ar = Math.max(1, window.innerWidth / Math.max(1, window.innerHeight));
        return Math.min(4.4, Math.max(2.4, 2.6 * ar)); 
      }

      let X_RANGE = computeXRANGE();     
      const Y_MIN_BAND = 0.20;           
      const Y_MAX_BAND = 1.25;           
      const EDGE_BIAS   = 0.6;           
      const EDGE_PAD    = 0.25;          
      const EMOJI_DIST_Z = -1.4;

      const EMOJI_SIZE_MIN = 0.09;
      const EMOJI_SIZE_MAX = 0.14;
      const MIN_SEPARATION = 0.25;
      const MAX_ONSCREEN   = 6;
      const LIFE_MS        = 2500;
      const BG_MIN_GAP_MS  = 6000;
      const BG_MAX_GAP_MS  = 11000;

      let emojiInterval = null;
      const ACTIVE_EMOJIS = new Set();

      const EMOJIS_RANDOM = ["üòÑ","üò¢","üò†","üòê","üòÇ","ü§î","ü•±","üò≥","üòé","ü§Ø"];

      function getCameraEl() {
        const scene = document.querySelector('a-scene');
        return scene?.camera?.el || scene?.querySelector('[camera]');
      }
      function emojiDataURL(face, sizePx = 256) {
        const c = document.createElement('canvas');
        c.width = c.height = sizePx;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, sizePx, sizePx);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.floor(sizePx*0.82)}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","EmojiOne Color","Twemoji Mozilla",sans-serif`;
        ctx.fillText(face, sizePx/2, sizePx/2);
        return c.toDataURL('image/png');
      }

      function emojiCanvas(face, sizePx = 256) {
        const c = document.createElement('canvas');
        c.width = c.height = sizePx;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, sizePx, sizePx);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.floor(sizePx*0.82)}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","EmojiOne Color","Twemoji Mozilla",sans-serif`;
        ctx.fillText(face, sizePx/2, sizePx/2);
        return c;
      }

      function sampleX() {
        const half = X_RANGE / 2;
        if (Math.random() < EDGE_BIAS) {
          const sign = Math.random() < 0.5 ? -1 : 1;
          return sign * (half - EDGE_PAD - Math.random() * 0.6); 
        }
        return (Math.random() - 0.5) * (X_RANGE * 0.65);
      }
      function sampleY() {
        return Y_MIN_BAND + Math.random() * (Y_MAX_BAND - Y_MIN_BAND);
      }

      function findFreePosition(size) {
        const halfDiag = Math.hypot(size, size) / 2;
        for (let tries = 0; tries < 18; tries++) {
          const x = sampleX();
          const y = sampleY();
          let ok = true;
          for (const meta of ACTIVE_EMOJIS) {
            const dx = x - meta.x, dy = y - meta.y;
            if (Math.hypot(dx, dy) < (MIN_SEPARATION + halfDiag + meta.halfDiag)) { ok = false; break; }
          }
          if (ok) return { x, y };
        }
        return { x: sampleX(), y: sampleY() };
      }

      async function spawnEmoji(face) {
        const camEl = getCameraEl();
        if (!camEl) return;
        if (ACTIVE_EMOJIS.size >= MAX_ONSCREEN) return;
      
        const chosen = face || EMOJIS_RANDOM[Math.floor(Math.random() * EMOJIS_RANDOM.length)];
        const size = EMOJI_SIZE_MIN + Math.random() * (EMOJI_SIZE_MAX - EMOJI_SIZE_MIN);
        const { x, y } = findFreePosition(size);
      
        const canvas = emojiCanvas(chosen, 256);
        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true;
      
        const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 1, depthTest: true });
        const sprite = new THREE.Sprite(mat);
      
        sprite.scale.set(size, size, 1);
        sprite.position.set(x, y, EMOJI_DIST_Z);
      
        camEl.object3D.add(sprite);
      
        const meta = { el: sprite, x, y, halfDiag: Math.hypot(size, size)/2, _tex: tex, _mat: mat };
        ACTIVE_EMOJIS.add(meta);
      
        console.log(`[Emojis] ${chosen} | pos=(${x.toFixed(2)},${y.toFixed(2)})`);
      
        const start = performance.now();
        const dur = LIFE_MS;
        function tick(t) {
          const k = Math.min(1, (t - start) / dur);
          mat.opacity = 1 - k;
          if (k < 1 && sprite.parent) requestAnimationFrame(tick);
          else {
            if (sprite.parent) camEl.object3D.remove(sprite);
            tex.dispose(); mat.dispose();
            ACTIVE_EMOJIS.delete(meta);
          }
        }
        requestAnimationFrame(tick);
      }

      function startEmojis() {
        stopEmojis();
        X_RANGE = computeXRANGE();
        spawnEmoji();
        const gap = BG_MIN_GAP_MS + Math.random() * (BG_MAX_GAP_MS - BG_MIN_GAP_MS);
        emojiInterval = setInterval(() => spawnEmoji(), gap);
        console.log(`[Emojis] ON | X_RANGE=${X_RANGE.toFixed(2)}, Y=[${Y_MIN_BAND},${Y_MAX_BAND}]`);
      }

      function stopEmojis() {
        if (emojiInterval) { clearInterval(emojiInterval); emojiInterval = null; }
        for (const meta of Array.from(ACTIVE_EMOJIS)) {
          if (meta.el && meta.el.parent) meta.el.parent.remove(meta.el);
          if (meta._tex) meta._tex.dispose();
          if (meta._mat) meta._mat.dispose();
          ACTIVE_EMOJIS.delete(meta);
        }
        console.log('[Emojis] OFF');
      }

      window.addEventListener('resize', () => { X_RANGE = computeXRANGE(); });
      
    </script>
    <script>
      function getNivel() {
        const params = new URLSearchParams(window.location.search);
        return params.get("nivel")?.toLowerCase() || "facil";
      }
      document.addEventListener("DOMContentLoaded", () => {
        const nivel = getNivel();
        const v1 = document.querySelector("#static-visitor");
        const v2 = document.querySelector("#static-visitor2");
        const v3 = document.querySelector("#static-visitor2_1");
        const v4 = document.querySelector("#static-visitor2_2");
        const v5 = document.querySelector("#static-visitor2_3");
        const v6 = document.querySelector("#static-visitor2_4");
        const v7 = document.querySelector("#static-visitor2_5");
        const v8 = document.querySelector("#static-visitor4");
        const v9 = document.querySelector("#static-visitor-3");
        const v10 = document.querySelector("#static-visitor-3_1");
        const v11 = document.querySelector("#static-visitor-3_2");
        const v12 = document.querySelector("#static-visitor-3_3");
        const v13 = document.querySelector("#static-visitor-3_4");
        const v14 = document.querySelector("#static-visitor-3_5");

        if (nivel === "facil") {
          if (v3) v3.setAttribute("visible", false); 
          if (v4) v4.setAttribute("visible", false);
          if (v5) v5.setAttribute("visible", false);
          if (v6) v6.setAttribute("visible", false);
          if (v7) v7.setAttribute("visible", false);
          if (v9) v9.setAttribute("visible", false);
          if (v10) v10.setAttribute("visible", false);
          if (v11) v11.setAttribute("visible", false);
          if (v12) v12.setAttribute("visible", false);
          if (v13) v13.setAttribute("visible", false);
          if (v14) v14.setAttribute("visible", false);
        }
        else if(nivel === "intermedio") {
          if (v1) v1.setAttribute("visible", false);
          if (v2) v2.setAttribute("visible", false);
          if (v8) v8.setAttribute("visible", false);
          if (v9) v9.setAttribute("visible", false);
          if (v10) v10.setAttribute("visible", false);
          if (v11) v11.setAttribute("visible", false);
          if (v12) v12.setAttribute("visible", false);
          if (v13) v13.setAttribute("visible", false);
          if (v14) v14.setAttribute("visible", false);
        }
        else if (nivel === "dificil"){
          if (v1) v1.setAttribute("visible", false);
          if (v2) v2.setAttribute("visible", false);
          if (v3) v3.setAttribute("visible", false); 
          if (v4) v4.setAttribute("visible", false);
          if (v5) v5.setAttribute("visible", false);
          if (v6) v6.setAttribute("visible", false);
          if (v7) v7.setAttribute("visible", false);
          if (v8) v8.setAttribute("visible", false);
        }
      });
    </script>
<script>
function safeShowScene() {
  const scene  = document.querySelector("#escena-vr");
  const loader = document.querySelector("#loader");
  if (!scene) return;

  console.log("üåÑ MODELO LISTO ‚Üí FADE IN");

  scene.style.opacity = "1";
  loader.style.opacity = "0";

  setTimeout(() => loader.remove(), 800);
}


function waitUntilModelReady() {
  const nivel = getNivel();
  const cont  = document.querySelector("#contenedor-modelo");

  let target;

  if (nivel === "facil")      target = "#modelo-facil";
  else if (nivel === "intermedio") target = "#modelo-inter";
  else                         target = "#modelo-dificil";

  console.log("‚è≥ Esperando MODEL-LOADED de", target);

  cont.addEventListener("model-loaded", safeShowScene, { once:true });

  // Fallback 5s
  setTimeout(() => {
    console.warn("‚ö† Fallback ‚Üí no lleg√≥ model-loaded, forzando fade");
    safeShowScene();
  }, 10000);
}

window.addEventListener("DOMContentLoaded", waitUntilModelReady);

</script>

  </body>
</html>

