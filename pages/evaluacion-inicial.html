<!DOCTYPE html>
<html lang="es">
  <head>
  <meta charset="utf-8">
  <title>Evaluaci√≥n VR - 3 Escenarios</title>
  <meta name="description" content="WebXR VR Evaluation System">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="../styles/evaluacion-inicial.css" />
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <style>
    .top-left-container,
    #loading-modal,
    #progreso-modal {
      display: none !important;
    }
  </style>
  <body>
  <div id="dom-overlay" style="position:fixed; inset:0; pointer-events:none; z-index:10000;">
    <div id="loader-escena"
       style="
          position:fixed; inset:0;
          background:white;
          z-index:9999;
          opacity:1;
          display:flex;
          justify-content:center;
          align-items:center;
          flex-direction:column;
          transition: opacity 0.8s ease-in-out;
       ">
    <div class="spinner"
         style="
            width:65px;
            height:65px;
            border:6px solid #e1e1e1;
            border-top:6px solid #9b59b6;
            border-radius:50%;
            animation:spin 1s linear infinite;
         ">
    </div>
    <p style="
          margin-top:18px;
          font-size:18px;
          color:#4b3b74;
          font-weight:600;
       ">
      Cargando inmersi√≥n...
    </p>
  </div>

    <div class="top-left-container" style="pointer-events:auto">
      <div id="timer-display">00:30</div>
      <button id="action-btn">INICIAR</button>
    </div>

    <div id="loading-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; pointer-events:auto;">
      <div style="background: white; padding: 60px 80px; border-radius: 20px; text-align: center; max-width: 500px;">
        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 28px;">Generando tus resultados,<br>no salgas de esta vista</h2>
        <div class="spinner" style="margin: 30px auto; width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #9b59b6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </div>
    </div>

    <div id="progreso-modal" class="result-overlay" style="display:none; pointer-events:auto;">
  <div class="result-card">
    <h3 class="result-title">Resultados</h3>

    <p id="resumen-progreso" class="result-text">
      ¬°Buen trabajo! Sigue intent√°ndolo.
    </p>

    <div id="estrellas-ultima-sesion" class="result-stars"></div>

    <button id="btn-salir" class="result-ok">Aceptar</button>
  </div>
</div>

  </div>

    <a-scene id="escena-vr" style="opacity:0;" lvl1-visitor-event="enabled:true" lvl2-visitor-event="enabled:false" lvl3-visitor-event="enabled:false" vr-mode-ui="enabled: true" shadow="type: pcfsoft" renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true" background="color: white" webxr="optionalFeatures: dom-overlay, hit-test; overlayElement: #dom-overlay">
      <a-assets>
        <audio id="snd-murmur" src="../audios/Murmur.mp3" preload="auto"></audio>
        <audio id="snd-door" src="../audios/door.mp3" preload="auto"></audio>
        <audio id="snd-yawn"   src="../audios/Yawn.mp3"   preload="auto"></audio>
        <audio id="snd-laugh"  src="../audios/Laugh.mp3"  preload="auto"></audio>
        <audio id="snd-caugh" src="../audios/cough.wav" preload="auto"></audio>
        <audio id="snd-wthought" src="../audios/WThought.mp3" preload="auto"></audio>
        <audio id="snd-cough" src="../audios/cough2.mp3" preload="auto"></audio>
      </a-assets>
      
      <a-entity id="world" >
      <a-entity id="contador-texto" visible="false"></a-entity>
      
      <a-entity id="contenedor-modelo" position="0 0 -3"></a-entity>

      <!-- VISITANTES NIVEL 1 -->
      <a-entity id="static-visitor"></a-entity>
      <a-entity id="static-visitor2"></a-entity>
      <a-entity id="static-visitor3"></a-entity>
      <a-entity id="static-visitor4"></a-entity>

      <!-- VISITANTES NIVEL 2 -->
      <a-entity id="static-visitor2_1"></a-entity>
      <a-entity id="static-visitor2_2"></a-entity>
      <a-entity id="static-visitor2_3"></a-entity>
      <a-entity id="static-visitor2_4"></a-entity>
      <a-entity id="static-visitor2_5"></a-entity>

      <!-- VISITANTES NIVEL 3 -->
      <a-entity id="static-visitor-3"></a-entity>
      <a-entity id="static-visitor-3_1"></a-entity>
      <a-entity id="static-visitor-3_2"></a-entity>
      <a-entity id="static-visitor-3_3"></a-entity>
      <a-entity id="static-visitor-3_4"></a-entity>
      <a-entity id="static-visitor-3_5"></a-entity>

      <a-entity id="fx-murmur" sound="src: #snd-murmur; autoplay: false; loop: false; positional: false; volume: 5"></a-entity>
      <a-entity id="fx-door" sound="src: #snd-door; autoplay: false; loop: false; positional: false; volume: 1"></a-entity>
      <a-entity id="fx-yawn"   sound="src: #snd-yawn;   autoplay: false; loop: false; positional: false; volume: 0.8"></a-entity>
      <a-entity id="fx-laugh"  sound="src: #snd-laugh;  autoplay: false; loop: false; positional: false; volume: "></a-entity>
      <a-entity id="fx-cough" sound="src: #snd-caugh; autoplay: false; loop: false; positional: false; volume: 0.1"></a-entity>
      <a-entity id="fx-wthought" sound="src: #snd-wthought; autoplay: false; loop: false; positional: false; volume: 0.3"></a-entity>
      <a-entity id="fx-cough2" sound="src: #snd-cough; autoplay: false; loop: false; positional: false; volume: 0.5"></a-entity>
      
      </a-entity>
      <a-entity id="ui-3d-container" position="-1.8 2.8 -2.5">
        <a-rounded id="timer-3d-bg"
                   width="0.6"
                   height="0.16"
                   radius="0.03"
                   color="#FFFFFF"
                   opacity="0.95"
                   position="0 0.19 0"
                   material="shader: flat">
          <a-text id="timer-3d-text"
                  value="00:30"
                  color="#3b2e6d"
                  align="center"
                  width="1.2"
                  position="0 0 0.01"
                  font="roboto"></a-text>
        </a-rounded>

        <a-rounded id="action-btn-3d"
                   width="0.5"
                   height="0.14"
                   radius="0.025"
                   color="#a48cf0"
                   position="0 0 0"
                   class="clickable"
                   material="shader: flat">
          <a-text id="action-btn-text"
                  value="INICIAR"
                  color="#FFFFFF"
                  align="center"
                  width="1.0"
                  position="0 0 0.03"
                  font="roboto"></a-text>
        </a-rounded>
      </a-entity>

      <a-entity id="loading-panel-3d"
                position="0 0 -2"
                visible="false"
                loading-modal-3d
                follow-camera>
        <a-plane width="50" height="50"
                 color="#000000"
                 opacity="0.75"
                 position="0 0 0"
                 material="shader: flat"></a-plane>

        <a-rounded width="1"
                   height="0.4"
                   radius="0.08"
                   color="#FFFFFF"
                   opacity="0.98"
                   position="0 0 0.01"
                   material="shader: flat"></a-rounded>

        <a-text value="Generando tus resultados,"
                align="center"
                width="1"
                color="#4A4A6A"
                position="0 0.1 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                scale="0.9 0.9 1"></a-text>

        <a-text value="no salgas de esta vista"
                align="center"
                width="1"
                color="#4A4A6A"
                position="0 0 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                scale="0.9 0.9 1"></a-text>

        <a-ring radius-inner="0.02"
                radius-outer="0.035"
                color="#f3f3f3"
                position="0 -0.10 0.02"
                material="shader: flat"></a-ring>

        <a-ring radius-inner="0.02"
                radius-outer="0.035"
                theta-length="270"
                color="#9b5de5"
                position="0 -0.10 0.03"
                material="shader: flat"
                animation="property: rotation; to: 0 0 360; loop: true; dur: 1000; easing: linear">
        </a-ring>
      </a-entity>

      <a-entity id="result-panel-3d"
                position="0 0 -1.5"
                visible="false"
                result-modal-3d
                follow-camera>

        <a-plane width="80" height="80"
                 color="#000000"
                 opacity="0.75"
                 position="0 0 0"
                 material="shader: flat"></a-plane>

        <a-rounded width="1.2"
                   height="0.8"
                   radius="0.08"
                   color="#FFFFFF"
                   opacity="0.98"
                   position="0 0 0.01"
                   material="shader: flat"></a-rounded>

        <a-text id="result-title-3d"
                value="Resultados"
                align="center"
                width="1.1"
                color="#4A4A6A"
                position="0 0.30 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                scale="1.2 1.2 1"></a-text>

        <a-text id="result-message-3d"
                value=""
                align="center"
                width="1.05"
                color="#4A4A6A"
                position="0 0.10 0.02"
                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"
                wrap-count="35"
                baseline="center"
                scale="0.9 0.9 1"></a-text>

        <a-entity id="result-stars-container-3d"
                  position="0 -0.1 0.02"></a-entity>

        <a-rounded id="result-ok-3d"
                   class="clickable"
                   width="0.4"
                   height="0.09"
                   radius="0.04"
                   color="#9b5de5"
                   position="0 -0.30 0.02"
                   material="shader: flat">
          <a-text value="Aceptar"
                  align="center"
                  width="0.8"
                  color="#FFFFFF"
                  position="0 0.01 0.03"
                  font="roboto"></a-text>
        </a-rounded>
      </a-entity>

   
      <a-entity camera look-controls wasd-controls position="0 1.6 0">
        <a-entity 
          cursor="fuse: true; fuseTimeout: 1000" 
          raycaster="objects: .clickable"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: black; shader: flat">
        </a-entity>
      </a-entity>
    </a-scene>
    <script src="./js/evaluacion-manifest.js"></script>
    <script src="./js/evaluacion-loader.js"></script>

    <script src="./js/api-base.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/easycontroller.js"></script>
    <script src="./js/intercontroller.js"></script>
    <script src="./js/difcontroller.js"></script>
    <script>
      AFRAME.registerGeometry('rounded', {
        schema: {
          width:  { default: 1, min: 0 },
          height: { default: 1, min: 0 },
          radius: { default: 0.1, min: 0 }
        },
        init: function (data) {
          const w = data.width;
          const h = data.height;
          const r = Math.min(data.radius, Math.min(w, h) / 2);
        
          const shape = new THREE.Shape();
          const x = -w / 2;
          const y = -h / 2;
        
          shape.moveTo(x + r, y);
          shape.lineTo(x + w - r, y);
          shape.quadraticCurveTo(x + w, y, x + w, y + r);
          shape.lineTo(x + w, y + h - r);
          shape.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
          shape.lineTo(x + r, y + h);
          shape.quadraticCurveTo(x, y + h, x, y + h - r);
          shape.lineTo(x, y + r);
          shape.quadraticCurveTo(x, y, x + r, y);
        
          this.geometry = new THREE.ShapeGeometry(shape);
        }
      });

      AFRAME.registerPrimitive('a-rounded', {
        defaultComponents: {
          geometry: { primitive: 'rounded' },
          material: {}
        },
        mappings: {
          width:  'geometry.width',
          height: 'geometry.height',
          radius: 'geometry.radius',
          color:  'material.color',
          opacity:'material.opacity'
        }
      });

      AFRAME.registerComponent('follow-camera', {
        init: function () {
          this.camera = document.querySelector('[camera]');
        },
        tick: function () {
          if (!this.camera) return;
          const p = this.camera.getAttribute('position');
          const r = this.camera.getAttribute('rotation');
        
          this.el.setAttribute('position', {
            x: p.x,
            y: p.y,
            z: p.z - 0.6
          });
        
          this.el.setAttribute('rotation', {
            x: 0,
            y: r.y,
            z: 0
          });
        }
      });

      AFRAME.registerComponent('loading-modal-3d', {
        init: function () {},
        show: function () {
          this.el.setAttribute('visible', true);
        },
        hide: function () {
          this.el.setAttribute('visible', false);
        }
      });

      AFRAME.registerComponent('result-modal-3d', {
        init: function () {
          this.titleEl = this.el.querySelector('#result-title-3d');
          this.msgEl = this.el.querySelector('#result-message-3d');
          this.starsContainer = this.el.querySelector('#result-stars-container-3d');
        
          const okBtn = this.el.querySelector('#result-ok-3d');
          if (okBtn) {
            okBtn.addEventListener('click', () => {
              window.location.href = '../pages/selector.html';
            });
          }
        },
      
        show: function (message, stars, title) {
          if (this.titleEl && title) {
            this.titleEl.setAttribute('value', title);
          }
          if (this.msgEl && message) {
            this.msgEl.setAttribute('value', message);
          }
        
          this.renderStars(stars);
          this.el.setAttribute('visible', true);
        },
      
        hide: function () {
          this.el.setAttribute('visible', false);
        },
      
        clearStars: function () {
          if (!this.starsContainer) return;
          while (this.starsContainer.firstChild) {
            this.starsContainer.removeChild(this.starsContainer.firstChild);
          }
        },
      
        renderStars: function (stars) {
          if (!this.starsContainer) return;
        
          let starCount = 0;
          if (typeof stars === 'number') {
            starCount = Math.max(0, Math.min(3, stars));
          } else if (typeof stars === 'string') {
            starCount = Math.max(0, Math.min(3, parseInt(stars, 10) || 0));
          }
        
          if (starCount === 0) {
            this.starsContainer.setAttribute('visible', 'false');
            this.clearStars();
            return;
          }
        
          this.starsContainer.setAttribute('visible', 'true');
          this.clearStars();
        
          const starSpacing = 0.2;
          const startX = -((starCount - 1) * starSpacing) / 2;
        
          for (let i = 0; i < starCount; i++) {
            const star = this.createPurpleStar();
            star.setAttribute('position', {
              x: startX + (i * starSpacing),
              y: -0.1,
              z: 0.02
            });
            this.starsContainer.appendChild(star);
          }
        },
      
        createPurpleStar: function () {
          const star = document.createElement('a-entity');
        
          const starShape = new THREE.Shape();
          const spikes = 5;
          const outerRadius = 0.07;
          const innerRadius = 0.035;
        
          let rot = (Math.PI / 2) * 3;
          let x = 0;
          let y = 0;
          const step = Math.PI / spikes;
        
          starShape.moveTo(0, -outerRadius);
        
          for (let i = 0; i < spikes; i++) {
            x = Math.cos(rot) * outerRadius;
            y = Math.sin(rot) * outerRadius;
            starShape.lineTo(x, y);
            rot += step;
          
            x = Math.cos(rot) * innerRadius;
            y = Math.sin(rot) * innerRadius;
            starShape.lineTo(x, y);
            rot += step;
          }
        
          starShape.lineTo(0, -outerRadius);
        
          const geometry = new THREE.ShapeGeometry(starShape);
          const material = new THREE.MeshBasicMaterial({
            color: 0x9b5de5,
            side: THREE.DoubleSide
          });
        
          const mesh = new THREE.Mesh(geometry, material);
          mesh.rotation.x = Math.PI;      
          mesh.scale.set(0.8, 0.8, 0.8);
        
          star.object3D.add(mesh);
          return star;
        }
      });

      function getCmp(id, name) {
        const el = document.querySelector(id);
        if (!el) return null;
        return el.components && el.components[name] ? el.components[name] : null;
      }

      window.showLoading3D = function () {
        const cmp = getCmp('#loading-panel-3d', 'loading-modal-3d');
        if (cmp) cmp.show();
      };

      window.hideLoading3D = function () {
        const cmp = getCmp('#loading-panel-3d', 'loading-modal-3d');
        if (cmp) cmp.hide();
      };

      window.showResult3D = function (message, stars, title) {
        const cmp = getCmp('#result-panel-3d', 'result-modal-3d');
        if (cmp) cmp.show(message, stars, title || 'Resultados');
      };

      window.hideResult3D = function () {
        const cmp = getCmp('#result-panel-3d', 'result-modal-3d');
        if (cmp) cmp.hide();
      };
    </script>
    <script>
      function removeEvalLights() {
        const scene = document.querySelector("a-scene");
        if (!scene) return;
            
        const oldLights = scene.querySelectorAll('[data-eval-light]');
        oldLights.forEach(light => light.parentNode.removeChild(light));
      }

      function applyEvalLights(rawLevelName) {
        const scene = document.querySelector("a-scene");
        if (!scene) return;
      
        const levelName = (rawLevelName || '').toString().toLowerCase();
      
        removeEvalLights();
      
        console.log(`[Iluminaci√≥n EVAL] Nivel: ${levelName} ‚Üí usando setup de GAME intermedio`);
      
        // Ambient
        const ambient = document.createElement("a-entity");
        ambient.setAttribute("light", {
          type: "ambient",
          color: "#FFFFFF",
          intensity:  0.9
        });
        scene.appendChild(ambient);
      
        // Directional sol
        const sun = document.createElement("a-entity");
        sun.setAttribute("light", {
          type: "directional",
          castShadow: true,
          color: "#FFFFFF",
          intensity: 4
        });
        sun.setAttribute("position", "1 4 -2");
        scene.appendChild(sun);
      
        // Hemisphere
        const fill = document.createElement("a-entity");
        fill.setAttribute("light", {
          type: "hemisphere",
          intensity: 1,
          groundColor: "#dddddd",
          color: "#FFFFFF"
        });
        fill.setAttribute("position", "0 3 0");
        scene.appendChild(fill);
      }

      document.addEventListener("escenario-cambiado", (ev) => {
        const idx = ev.detail?.indice ?? 0;
        const escenario = window.EVAL_MANIFEST?.escenarios?.[idx];
        const levelName = escenario?.immersion_level_name;
      
        if (levelName) {
          applyEvalLights(levelName);
        } else {
          applyEvalLights('intermedio');
        }
      
        const sky = document.querySelector('#sky');
        if (sky && escenario?.skyColor) {
          sky.setAttribute('color', escenario.skyColor);
        }
      });

    </script>

    <script>
      const VISITORS_BY_LEVEL = {
        0: ["#static-visitor","#static-visitor2","#static-visitor4"],
        1: ["#static-visitor2_1","#static-visitor2_2","#static-visitor2_3","#static-visitor2_5"],
        2: ["#static-visitor-3","#static-visitor-3_1","#static-visitor-3_2","#static-visitor-3_3","#static-visitor-3_4","#static-visitor-3_5"]
      };

      const VISITOR_COMPONENTS = [
        "lvl1-visitor-event",
        "lvl2-visitor-event",
        "lvl3-visitor-event"
      ];

      function setVisible(list, visible) {
        list?.forEach(id => {
          const el = document.querySelector(id);
          el?.setAttribute("visible", visible);
        });
      }

      function resetVisitorSystems(targetLevel) {
        const scene = document.querySelector("a-scene");
        if (!scene) return console.error("No <a-scene> found");

        VISITOR_COMPONENTS.forEach((name, i) => {
          if (scene.hasAttribute(name)) scene.removeAttribute(name);
          if (i === targetLevel) {
            scene.setAttribute(name, "enabled: true");
            console.log(`Restarted Visitor Controller ‚Üí ${name}`);
          }
        });
      }

      document.addEventListener("escenario-cambiado", e => {
        const idx = Number(e.detail.indice);
        console.log(`ESCENARIO CAMBIADO ‚Üí ${idx}`);

        Object.values(VISITORS_BY_LEVEL).flat().forEach(id => {
          document.querySelector(id)?.setAttribute("visible", false);
        });

        resetVisitorSystems(idx);

        VISITORS_BY_LEVEL[idx].forEach(id => {
          document.querySelector(id)?.setAttribute("visible", true);
        });

        
      });


      const estado = {
        escenarioActual: 0,
        tiempoRestante: 30,
        mediaRecorder: null,
        audioChunks: [],
        grabando: false,
        resultados: [],
        audiosEnProceso: 0,
        intervalo: null,
        esperandoInicio: true,
        modeloCargado: false,
        pendientes: 0,   
        completados: 0,
        allAudiosPromise: null,
        resolveAllAudios: null 
      };

      const elementos = {
        escena: document.querySelector('#escena-vr'),
        contenedor: document.querySelector('#contenedor-modelo'),
        contadorTexto: document.querySelector('#contador-texto'),
        loadingModal: document.querySelector('#loading-modal'),
        modal: document.querySelector('#progreso-modal'),
        estrellasRow: document.querySelector('#estrellas-ultima-sesion'),
        resumenProgreso: document.querySelector('#resumen-progreso'),
        btnSalir: document.querySelector('#btn-salir'),
        timerDisplay: document.getElementById('timer-display'),
        actionBtn: document.getElementById('action-btn'),
        loaderEscena: document.getElementById('loader-escena')
      };

            const ui3d = {
        timerText: document.getElementById('timer-3d-text'),
        button: document.getElementById('action-btn-3d'),
        buttonText: document.getElementById('action-btn-text')
      };

      function syncTimerUI(value) {
        if (elementos.timerDisplay) {
          elementos.timerDisplay.textContent = value;
        }
        if (ui3d.timerText) {
          ui3d.timerText.setAttribute('value', value);
        }
      }

      function syncButtonLabel(value) {
        if (elementos.actionBtn) {
          elementos.actionBtn.textContent = value;
        }
        if (ui3d.buttonText) {
          ui3d.buttonText.setAttribute('value', value);
        }
      }

      function syncButtonVisible(show) {
        const displayVal = show ? 'block' : 'none';
        if (elementos.actionBtn) {
          elementos.actionBtn.style.display = displayVal;
        }
        if (ui3d.button) {
          ui3d.button.setAttribute('visible', !!show);
        }
      }

      function syncButtonEnabled(enabled) {
        if (elementos.actionBtn) {
          elementos.actionBtn.disabled = !enabled;
        }
        if (ui3d.button) {
          if (enabled) ui3d.button.classList.add('clickable');
          else ui3d.button.classList.remove('clickable');
        }
      }


      function showMicBanner(message, color = "#842029", bg = "#f8d7da", border = "#f5c2c7") {
        let bar = document.getElementById("mic-banner");
        if (!bar) {
          bar = document.createElement("div");
          bar.id = "mic-banner";
          bar.style.cssText = `
            position:fixed; top:16px; left:50%; transform:translateX(-50%);
            z-index:99999;
            background:${bg}; color:${color}; border:1px solid ${border};
            border-radius:12px; padding:14px 18px;
            font:500 14px Inter,system-ui,Arial,sans-serif;
            max-width:min(90vw,720px); text-align:center;
            box-shadow:0 6px 20px rgba(0,0,0,.15);
          `;
          document.body.appendChild(bar);
        }
        bar.textContent = message;
        setTimeout(() => bar?.remove?.(), 8000);
      }

      function handleMicError(err) {
        let msg;
        switch (err?.name) {
          case "NotAllowedError":
            msg = "El microfono esta bloqueado. Activalo en Configuracion > Privacidad > Microfono o permite el acceso desde el navegador.";
            break;
          case "NotFoundError":
            msg = "No se detecto ningun microfono conectado o esta apagado en los ajustes del sistema.";
            break;
          case "NotReadableError":
            msg = "Otro programa esta usando el micr√≥fono. Cierralo e intentalo nuevamente.";
            break;
          default:
            msg = "No se pudo acceder al microfono. Revisa la configuracion.";
        }
        showMicBanner(msg);
        throw err;
      }

      async function ensureMicReady() {
        try {
          if (navigator.permissions?.query) {
            const p = await navigator.permissions.query({ name: "microphone" });
            if (p.state === "denied") {
              handleMicError({ name: "NotAllowedError" });
            }
          }
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(t => t.stop());
          return true;
        } catch (e) {
          handleMicError(e);
        }
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }

      function showInitialTime() {
        const t = formatTime(30);
        syncTimerUI(t);
        syncButtonLabel('INICIAR');
        syncButtonVisible(true);
        syncButtonEnabled(false);
      }


      let uiCountdownInterval = null;

      function startAutoCountdown() {
        let countdownSeconds = 30;
        syncTimerUI(formatTime(countdownSeconds));
      
        uiCountdownInterval = setInterval(() => {
          if (countdownSeconds > 0) {
            countdownSeconds--;
            syncTimerUI(formatTime(countdownSeconds));
          } else {
            clearInterval(uiCountdownInterval);
            uiCountdownInterval = null;
          }
        }, 1000);
      }


      function stopAutoCountdown() {
        if (uiCountdownInterval) {
          clearInterval(uiCountdownInterval);
          uiCountdownInterval = null;
        }
      }


      async function getUserId() {
        const ls = localStorage.getItem('user_id');
        if (ls) return Number(ls);
        try {
          const base = 'https://vr-backend-api-asdperfqg9a4fncv.canadacentral-01.azurewebsites.net';
          const r = await fetch(`${base}/api/auth/me`, { credentials: 'include' });
          if (!r.ok) return null;
          const me = await r.json();
          localStorage.setItem('user_id', me.user_id);
          return me.user_id;
        } catch { return null; }
      }

     function drawStars(n = 0) {
      elementos.estrellasRow.innerHTML = '';
      for (let i = 0; i < Math.max(0, n); i++) {
        const s = document.createElement('span');
        s.textContent = '‚òÖ';             
        s.className = 'star';           
        elementos.estrellasRow.appendChild(s);
      }
    }

     function buildEvalFeedbackMessage({ nivelNombre, band, pauseRatio }) {
        let texto = `Tu nivel asignado es: <span style="font-weight:700; color:#7c3aed;">nivel ${nivelNombre}</span>. `;

        if (band === "baja") {
          texto += "Mostraste buen control emocional durante la evaluacion. ";
        } else if (band === "media") {
          texto += "Hubieron momentos de calma y otros donde los nervios se hicieron notar, algo normal en este tipo de ejercicios. ";
        } else if (band === "alta") {
          texto += "Se noto bastante tension durante la evaluacion, pero lo importante es que te animaste a intentarlo. ";
        }
      
        if (typeof pauseRatio === "number" && !Number.isNaN(pauseRatio)) {
          if (pauseRatio > 0.45) {
            texto += "Hiciste varias pausas largas; con practica puedes hacer que tu discurso suene mas fluido. ";
          } else if (pauseRatio > 0.25) {
            texto += "Hiciste algunas pausas naturales al hablar, aunque a veces cortaron un poco el ritmo. ";
          } else {
            texto += "Mantuviste un ritmo bastante continuo y tu mensaje fluyo bien. ";
          }
        }
      
        texto += "Este resultado es un punto de partida para seguir creciendo paso a paso.";
      
        return texto.trim();
      }

      function obtenerNivelPorAnsiedad(ansiedadPct) {
        if (ansiedadPct >= 66) return { nombre: 'Facil', color: '#4CAF50' };
        if (ansiedadPct >= 33) return { nombre: 'Intermedio', color: '#FF9800' };
        return { nombre: 'Dificil', color: '#F44336' };
      }

      function esperarSegundos(segundos) {
        return new Promise(resolve => setTimeout(resolve, segundos * 1000));
      }

      elementos.escena.addEventListener('loaded', () => {
      console.log('Escena VR cargada');
      window.evalMode = true;
      window.visitorEventEnabled = false;
      showInitialTime();

      if (typeof window.initEvaluacionLoader === 'function') {
        console.log('Iniciando loader de evaluaci√≥n...');
        window.initEvaluacionLoader()
          .then(() => {
            console.log('‚úÖ Loader completado - Ocultando spinner');
            estado.modeloCargado = true;

            if (elementos.loaderEscena) {
              elementos.loaderEscena.style.opacity = '0';
              setTimeout(() => {
                elementos.loaderEscena.style.display = 'none';
                elementos.escena.style.opacity = '1'; 
                syncButtonEnabled(true);
              }, 800);
            } else {
              elementos.escena.style.opacity = '1';
              syncButtonEnabled(true);
            }
          })
          .catch(err => {
            console.error('Error en loader:', err);
            estado.modeloCargado = true;

            if (elementos.loaderEscena) {
              elementos.loaderEscena.style.display = 'none';
            }
            elementos.escena.style.opacity = '1';
            syncButtonEnabled(true);
          });
      } else {
        console.error('initEvaluacionLoader no disponible');
        if (elementos.loaderEscena) {
          elementos.loaderEscena.style.display = 'none';
        }
        elementos.escena.style.opacity = '1';
      }
    });

      function handleStartClick() {
        if (estado.esperandoInicio && estado.escenarioActual === 0 && estado.modeloCargado) {
          window.evalMode = true;
          estado.esperandoInicio = false;
          syncButtonVisible(false);
          iniciarEscenarioActual();
        }
      }

      if (elementos.actionBtn) {
        elementos.actionBtn.addEventListener('click', handleStartClick);
      }
      if (ui3d.button) {
        ui3d.button.addEventListener('click', handleStartClick);
      }

    async function cambiarEscenario(indice) {
      window.visitorEventEnabled = false;
      
      if (elementos.loaderEscena) {
        elementos.loaderEscena.style.display = 'flex';
        elementos.loaderEscena.style.opacity = '1';
      }
      
      if (indice >= 3) {
        await finalizarEvaluacion();
        return;
      }
      
    
      estado.escenarioActual = indice;
      estado.modeloCargado = false;
      elementos.escena.style.opacity = 0;
      
      
      console.log(`Cambiando a escenario ${indice}...`);
      
      const success = await window.switchToEvalScenario(indice);
      
      if (success) {
        estado.modeloCargado = true;
        
        if (elementos.loaderEscena) {
          elementos.loaderEscena.style.opacity = '0';
          setTimeout(() => {
            elementos.loaderEscena.style.display = 'none';
            elementos.escena.style.opacity = 1; 
          }, 800);
        } else {
          elementos.escena.style.opacity = 1;
        }
      
        if (indice === 0) {
          syncButtonEnabled(true);
          syncButtonLabel('INICIAR');
          syncButtonVisible(true);
        } else {
          iniciarEscenarioActual();
        }
      } else {
        console.error(`Error cambiando a escenario ${indice}`);
        estado.modeloCargado = true;
        if (elementos.loaderEscena) {
          elementos.loaderEscena.style.display = 'none';
        }
        elementos.escena.style.opacity = 1;
      }
    }

      async function iniciarEscenarioActual() {
        window.visitorEventEnabled = true;
        const escenario = window.EVAL_MANIFEST.escenarios[estado.escenarioActual];
        console.log(`Iniciando escenario: ${escenario.nombre}`);

        const ok = await iniciarGrabacion();
        if (!ok) {
          elementos.actionBtn.style.display = 'block';
          elementos.actionBtn.textContent = 'INICIAR';
          elementos.timerDisplay.textContent = formatTime(30);
          return;
        }
  
        startAutoCountdown();
        iniciarContador(escenario);
      }


      async function iniciarGrabacion() {
        try {
          await ensureMicReady(); 
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
          estado.audioChunks = [];
          estado.mediaRecorder = new MediaRecorder(stream);
        
          estado.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) estado.audioChunks.push(event.data);
          };
        
          estado.mediaRecorder.start();
          estado.grabando = true;
          console.log('üéôÔ∏è Grabaci√≥n iniciada');
          return true;
        } catch (error) {
          console.error('Error al iniciar grabacion:', error);
          stopAutoCountdown();
        
          syncButtonVisible(true);
          syncButtonLabel('INICIAR');
          syncTimerUI(formatTime(30));
          estado.esperandoInicio = true;
          return false;

        }
      }



      function detenerGrabacion() {
        return new Promise((resolve) => {
          if (estado.mediaRecorder && estado.grabando) {
            estado.mediaRecorder.onstop = async () => {
              const audioBlob = new Blob(estado.audioChunks, { type: 'audio/webm' });
              const escenarioInfo = window.EVAL_MANIFEST.escenarios[estado.escenarioActual];
              console.log(`üé¨ Grabaci√≥n terminada para ${escenarioInfo.nombre}`);

              procesarAudioEnBackground(audioBlob, estado.escenarioActual);

              estado.mediaRecorder.stream.getTracks().forEach(track => track.stop());
              estado.grabando = false;
              elementos.escena.style.opacity = 0;
              window.visitorEventEnabled = false;

              await esperarSegundos(0.25);

              if (estado.escenarioActual < window.EVAL_MANIFEST.escenarios.length - 1) {
                cambiarEscenario(estado.escenarioActual + 1);
              } else {
                finalizarEvaluacion();
              }

              resolve();
            };

            
            estado.mediaRecorder.stop();
          } else {
            resolve();
          }
        });
      }

      function iniciarContador(escenario) {
        estado.tiempoRestante = 30;

        if (estado.intervalo) clearInterval(estado.intervalo);

        estado.intervalo = setInterval(() => {
          estado.tiempoRestante--;
        
          if (estado.tiempoRestante <= 0) {
            clearInterval(estado.intervalo);
            detenerGrabacion();
          }
        }, 1000);
      }


      async function procesarAudioEnBackground(audioBlob, indiceEscenario) {
        const escenario = window.EVAL_MANIFEST.escenarios[indiceEscenario];
        console.log(`üéôÔ∏è Procesando audio ${indiceEscenario + 1}/${window.EVAL_MANIFEST.escenarios.length}: ${escenario.nombre}`);
        estado.pendientes++;

        if (!estado.allAudiosPromise) {
          estado.allAudiosPromise = new Promise(res => {
            estado.resolveAllAudios = res;
          });
        }
      
        const base = 'https://vr-backend-api-asdperfqg9a4fncv.canadacentral-01.azurewebsites.net';
        let user_id = null;
      
        try {
          user_id = await getUserId();
          if (!user_id) throw new Error('Sesi√≥n no v√°lida');
        
          const formData = new FormData();
          formData.append('audio', audioBlob, `evaluacion_${escenario.id}.webm`);
          formData.append('user_id', String(user_id));
          formData.append('immersion_level_name', escenario.immersion_level_name);
        
          fetch(`${base}/api/sessions/eval/audio`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
          })
          .then(async (response) => {
            console.log(`‚åõ Esperando respuesta del servidor para audio ${indiceEscenario + 1}/${window.EVAL_MANIFEST.escenarios.length}...`);
            if (!response.ok) {
              let err = 'Error al procesar audio';
              try { const e = await response.json(); err = e.error || err; } catch {}
              throw new Error(err);
            }

            const data = await response.json();
            const payload = data?.result || data;
            const model  = payload?.model || payload;
            const detail = payload?.detail || data?.detail || {};

            const ansiedadRaw = model?.anxiety_pct;
            const ansiedadNum = Number(ansiedadRaw);
            const ansiedadValida = Number.isFinite(ansiedadNum);

            if (!ansiedadValida) {
              console.warn(`Ansiedad inv√°lida para audio ${indiceEscenario + 1}:`, ansiedadRaw);
            
              estado.resultados[indiceEscenario] = {
                escenario: escenario.nombre,
                nivel: escenario.nivel,
                error: true,
                mensaje: "No se detecto ninguna voz, por favor intentar de nuevo."
              };
            } else {
              const resultado = {
                escenario: escenario.nombre,
                nivel: escenario.nivel,
                ansiedad: ansiedadNum,
                estrellas: detail?.star_rating ?? null,
                progreso: detail?.progress_percentage ?? null,
                band: model?.band ?? null,
                pauseRatio: model?.pause_ratio ?? null,
                pauseCount: model?.pause_count ?? null,
                pausesPerMin: model?.pauses_per_min ?? null,
                audioSeconds: model?.audio_seconds ?? null,
                silenceSeconds: model?.silence_seconds ?? null,
                error: false
              };
            
              estado.resultados[indiceEscenario] = resultado;
            
              console.log(`Audio ${indiceEscenario + 1}/${window.EVAL_MANIFEST.escenarios.length} procesado correctamente.`);
              console.log(
                `   ‚Üí Ansiedad: ${resultado.ansiedad ?? 'N/A'} | Estrellas: ${resultado.estrellas ?? 'N/A'} | Progreso: ${resultado.progreso ?? 'N/A'}`
              );
            }


          })
          .catch((error) => {
            console.error(`Error procesando audio ${indiceEscenario + 1}:`, error);
            estado.resultados[indiceEscenario] = {
              escenario: escenario.nombre,
              nivel: escenario.nivel,
              error: true,
              mensaje: error.message
            };
          })
          .finally(() => {
            estado.completados++;
            console.log(`Audios completados: ${estado.completados}/${window.EVAL_MANIFEST.escenarios.length}`);
            const TOTAL = window.EVAL_MANIFEST.escenarios.length;
            if (estado.resolveAllAudios && estado.completados >= TOTAL) {
              estado.resolveAllAudios();
              estado.resolveAllAudios = null;
            }
          });
        
        } catch (error) {
          console.error(`Error preparando env√≠o de audio ${indiceEscenario + 1}:`, error);
          estado.resultados[indiceEscenario] = {
            escenario: escenario.nombre,
            nivel: escenario.nivel,
            error: true,
            mensaje: error.message
          };
          estado.completados++;
          console.log(`Audios completados: ${estado.completados}/${window.EVAL_MANIFEST.escenarios.length}`);
          const TOTAL = window.EVAL_MANIFEST.escenarios.length;
          if (estado.resolveAllAudios && estado.completados >= TOTAL) {
            estado.resolveAllAudios();
            estado.resolveAllAudios = null;   
          }
        }
      }


      async function finalizarEvaluacion() {
        console.log('Finalizando evaluacion...');
        if (elementos.loadingModal) {
          elementos.loadingModal.style.display = 'flex';
        }

        if (elementos.escena) {
          elementos.escena.style.opacity = '1';
        }
        if (elementos.loaderEscena) {
          elementos.loaderEscena.style.opacity = '0';
          elementos.loaderEscena.style.display = 'none';
        }

        if (elementos.loadingModal) {
          elementos.loadingModal.style.display = 'flex';
        }
        showLoading3D();

                const TOTAL = window.EVAL_MANIFEST.escenarios.length;
        const TIMEOUT_MS = 90_000;

        if (estado.allAudiosPromise) {
          await Promise.race([
            estado.allAudiosPromise,
            new Promise(res => setTimeout(res, TIMEOUT_MS))
          ]);
        } else {
          const T0 = performance.now();
          while (estado.completados < TOTAL && (performance.now() - T0) < TIMEOUT_MS) {
            await esperarSegundos(0.25);
          }
        }

        console.log(`Audios completados: ${estado.completados}/${TOTAL}`);

      
        const resultadosValidos = estado.resultados.filter(
          r => r && !r.error && Number.isFinite(r.ansiedad)
        );
        console.log('Resultados v√°lidos:', resultadosValidos);

        if (resultadosValidos.length === 0) {
          if (elementos.loadingModal) {
            elementos.loadingModal.style.display = 'none';
          }
          hideLoading3D();
        
          elementos.resumenProgreso.textContent = "No se detecto ninguna voz, por favor intentar de nuevo.";
          elementos.resumenProgreso.style.fontSize = '22px';
          elementos.estrellasRow.innerHTML = ""; 
        
          if (elementos.modal) {
            elementos.modal.style.display = 'flex';
            elementos.modal.classList.add('active');
          }

          showResult3D(elementos.resumenProgreso.textContent, 0, 'Resultados');
          return;
        }


        const ansiedadMaxima = Math.max(...resultadosValidos.map(r => r.ansiedad || 0));
        console.log(`Ansiedad m√°xima detectada: ${ansiedadMaxima}%`);

        const nivelAsignado = obtenerNivelPorAnsiedad(ansiedadMaxima);
        console.log(`Nivel asignado: ${nivelAsignado.nombre}`);

        const refResultado = resultadosValidos.reduce((best, r) => {
          if (!best) return r;
          return (r.ansiedad || 0) > (best.ansiedad || 0) ? r : best;
        }, null);

        await asignarNivelInicial(ansiedadMaxima);

        if (elementos.loadingModal) {
          elementos.loadingModal.style.display = 'none';
        }
        hideLoading3D();


        const starsByLevel = {
          "Facil": 1,
          "Intermedio": 2,
          "Dificil": 3
        };
        const estrellasNivel = starsByLevel[nivelAsignado.nombre] || 0;

        const feedbackHtml = buildEvalFeedbackMessage({
          nivelNombre: nivelAsignado.nombre,
          band: refResultado?.band ?? null,
          pauseRatio: refResultado?.pauseRatio ?? null
        });

        elementos.resumenProgreso.innerHTML = feedbackHtml;
        elementos.resumenProgreso.style.fontSize = '22px';
        
        drawStars(estrellasNivel);

        if (elementos.modal) {
          elementos.modal.style.display = 'flex';
          elementos.modal.classList.add('active');
        }

        const plainText = elementos.resumenProgreso.textContent || elementos.resumenProgreso.innerText || '';
        showResult3D(plainText, estrellasNivel, 'Resultados');

        
      }


      async function asignarNivelInicial(ansiedadMaxima) {
        try {
          const base = 'https://vr-backend-api-asdperfqg9a4fncv.canadacentral-01.azurewebsites.net';
          
          const response = await fetch(`${base}/api/users/me/assign-initial-level`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ anxiety_pct_max: ansiedadMaxima }),
            credentials: 'include'
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Error asignando nivel');
          }

          console.log('Nivel inicial asignado:', data.assigned_level);
          
          return data.assigned_level;
          
        } catch (error) {
          console.error('Error asignando nivel inicial:', error);
          return null;
        }
      }

      elementos.btnSalir.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '../pages/selector.html';
      });

      const sceneEl = document.querySelector('#escena-vr');
      const fxMurmurEl = document.querySelector('#fx-murmur');

      function comp(el){ return el?.components?.sound ?? null; }

      const CUE_MIN_GAP = 9;
      const CUE_MAX_GAP = 16;
      const CUE_FIRE_PROB = 0.75;
      const MIN_SEP_MS = 4000;

      let audioUnlocked = false;
      let cueTimer = null;
      let lastCueAt = -Infinity;

      const NAME_MAP = { 'fx-murmur':'Murmur' };
      function logCue(el){
        const name = NAME_MAP[el.id] || el.id;
        const t = new Date().toLocaleTimeString();
        const remaining = typeof estado?.tiempoRestante === 'number' ? estado.tiempoRestante : 0;
        console.log(`[AudioCue] ${name} @ ${t} | restante: ${remaining}s`);
      }

      async function unlockAudio() {
        try {
          const ctx = AFRAME.audioContext;
          if (ctx && ctx.state !== 'running') await ctx.resume();
          for (const id of ['snd-murmur','snd-yawn','snd-laugh']) {
            const el = document.getElementById(id);
            try { const v=el.volume; el.volume=0; await el.play(); el.pause(); el.currentTime=0; el.volume=v; } catch {}
          }
          audioUnlocked = true;
        } catch(e){ console.warn('[Audio] unlock fail', e); }
      }

      function now(){ return performance.now(); }

      function playEl(el){
        const c = comp(el);
        if (!c) { el.addEventListener('sound-loaded', ()=>playEl(el), {once:true}); return; }
        const t = now();
        if (t - lastCueAt < MIN_SEP_MS) return;
        lastCueAt = t;
        c.stopSound();
        c.playSound();
        logCue(el);
        triggerEmojiBurst(el.id);
      }

      function scheduleNextCue(){
        const gap = CUE_MIN_GAP + Math.random()*(CUE_MAX_GAP - CUE_MIN_GAP);
        cueTimer = setTimeout(()=>{
          if (Math.random() < CUE_FIRE_PROB) {
            playEl(fxMurmurEl);
          }
          scheduleNextCue();
        }, gap*1000);
      }

      function startAudioCues(){
        stopAudioCues();
        unlockAudio();
        lastCueAt = -Infinity;
        scheduleNextCue();
        console.log('[Audio] ON (probabil√≠stico)');
      }

      function stopAudioCues(){
        if (cueTimer) { clearTimeout(cueTimer); cueTimer = null; }
        const c = comp(fxMurmurEl); if (c?.isPlaying) c.stopSound();
        console.log('[Audio] OFF');
      }

      function computeXRANGE() {
        const ar = Math.max(1, window.innerWidth / Math.max(1, window.innerHeight));
        return Math.min(4.4, Math.max(2.4, 2.6 * ar));
      }
      let X_RANGE = computeXRANGE();
      const Y_MIN_BAND = 0.20;
      const Y_MAX_BAND = 1.25;
      const EDGE_BIAS  = 0.6;
      const EDGE_PAD   = 0.25;
      const EMOJI_DIST_Z = -1.4;

      const EMOJI_SIZE_MIN = 0.09;
      const EMOJI_SIZE_MAX = 0.14;
      const MIN_SEPARATION = 0.25;
      const MAX_ONSCREEN   = 6;
      const LIFE_MS        = 2500;
      const BG_MIN_GAP_MS  = 6000;
      const BG_MAX_GAP_MS  = 11000;

      let emojiInterval = null;
      const ACTIVE_EMOJIS = new Set();

      const EMOJIS_RANDOM = ["üòÑ","üò¢","üò†","üòê","üòÇ","ü§î","ü•±","üò≥","üòé","ü§Ø"];
      function getCameraEl() {
        const scene = document.querySelector('a-scene');
        return scene?.camera?.el || scene?.querySelector('[camera]');
      }
      function emojiCanvas(face, sizePx = 256) {
        const c = document.createElement('canvas');
        c.width = c.height = sizePx;
        const ctx = c.getContext('2d');
        ctx.clearRect(0, 0, sizePx, sizePx);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `${Math.floor(sizePx*0.82)}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","EmojiOne Color","Twemoji Mozilla",sans-serif`;
        ctx.fillText(face, sizePx/2, sizePx/2);
        return c;
      }
      function sampleX() {
        const half = X_RANGE / 2;
        if (Math.random() < EDGE_BIAS) {
          const sign = Math.random() < 0.5 ? -1 : 1;
          return sign * (half - EDGE_PAD - Math.random() * 0.6);
        }
        return (Math.random() - 0.5) * (X_RANGE * 0.65);
      }
      function sampleY() {
        return Y_MIN_BAND + Math.random() * (Y_MAX_BAND - Y_MIN_BAND);
      }
      function findFreePosition(size) {
        const halfDiag = Math.hypot(size, size) / 2;
        for (let tries = 0; tries < 18; tries++) {
          const x = sampleX(), y = sampleY();
          let ok = true;
          for (const meta of ACTIVE_EMOJIS) {
            if (Math.hypot(x - meta.x, y - meta.y) < (MIN_SEPARATION + halfDiag + meta.halfDiag)) { ok=false; break; }
          }
          if (ok) return { x, y };
        }
        return { x: sampleX(), y: sampleY() };
      }
      async function spawnEmoji(face) {
        const camEl = getCameraEl();
        if (!camEl) return;
        if (ACTIVE_EMOJIS.size >= MAX_ONSCREEN) return;
      
        const chosen = face || EMOJIS_RANDOM[Math.floor(Math.random() * EMOJIS_RANDOM.length)];
        const size = EMOJI_SIZE_MIN + Math.random() * (EMOJI_SIZE_MAX - EMOJI_SIZE_MIN);
        const { x, y } = findFreePosition(size);
      
        const canvas = emojiCanvas(chosen, 256);
        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true;
      
        const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 1, depthTest: true });
        const sprite = new THREE.Sprite(mat);
        sprite.scale.set(size, size, 1);
        sprite.position.set(x, y, EMOJI_DIST_Z);
      
        camEl.object3D.add(sprite);
      
        const meta = { el: sprite, x, y, halfDiag: Math.hypot(size,size)/2, _tex: tex, _mat: mat };
        ACTIVE_EMOJIS.add(meta);
      
        const start = performance.now(), dur = LIFE_MS;
        function tick(t) {
          const k = Math.min(1, (t - start) / dur);
          mat.opacity = 1 - k;
          if (k < 1 && sprite.parent) requestAnimationFrame(tick);
          else {
            if (sprite.parent) camEl.object3D.remove(sprite);
            tex.dispose(); mat.dispose();
            ACTIVE_EMOJIS.delete(meta);
          }
        }
        requestAnimationFrame(tick);
      }
      function triggerEmojiBurst(audioId) {
        const set = EMOJI_MAP[audioId];
        if (!set) return;
        const slots = Math.max(0, MAX_ONSCREEN - ACTIVE_EMOJIS.size);
        if (slots === 0) return;
        const n = Math.min(slots, 3 + Math.floor(Math.random() * 3));
        for (let i = 0; i < n; i++) {
          const face = set[Math.floor(Math.random() * set.length)];
          setTimeout(() => spawnEmoji(face), i * 120);
        }
      }
      function startEmojis() {
        stopEmojis();
        X_RANGE = computeXRANGE();
        spawnEmoji();
        const gap = BG_MIN_GAP_MS + Math.random() * (BG_MAX_GAP_MS - BG_MIN_GAP_MS);
        emojiInterval = setInterval(() => spawnEmoji(), gap);
        console.log('[Emojis] ON');
      }
      function stopEmojis() {
        if (emojiInterval) { clearInterval(emojiInterval); emojiInterval = null; }
        for (const meta of Array.from(ACTIVE_EMOJIS)) {
          if (meta.el && meta.el.parent) meta.el.parent.remove(meta.el);
          if (meta._tex) meta._tex.dispose();
          if (meta._mat) meta._mat.dispose();
          ACTIVE_EMOJIS.delete(meta);
        }
        console.log('[Emojis] OFF');
      }
      window.addEventListener('resize', () => { X_RANGE = computeXRANGE(); });

      const _iniciarEscenarioActual = iniciarEscenarioActual;
      iniciarEscenarioActual = async function(){
        startAudioCues();
        startEmojis();
        return _iniciarEscenarioActual.apply(this, arguments);
      };

      const originalDetenerGrabacion = detenerGrabacion;

      detenerGrabacion = function(...args) {
        stopAudioCues();
        stopEmojis();
        return originalDetenerGrabacion(...args);
      };

      sceneEl.addEventListener('enter-vr',  ()=>{ startAudioCues(); startEmojis(); });
      sceneEl.addEventListener('exit-vr',   ()=>{ stopAudioCues(); stopEmojis(); });
      sceneEl.addEventListener('enter-ar',  ()=>{ startAudioCues(); startEmojis(); });
      sceneEl.addEventListener('exit-ar',   ()=>{ stopAudioCues(); stopEmojis(); });
    </script>
    
  </body>
</html>