<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Menú VR Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="../styles/main.css" />
</head>
<body>
<div id="progress-overlay" role="dialog" aria-modal="true" aria-labelledby="progress-title">
  <div id="progress-card">
    <h3 id="progress-title">Progreso</h3>
    <div id="progress-stars" style="font-size:32px; color:#7a36ff; text-align:center; letter-spacing:6px; margin:8px 0 14px">—</div>
    <div id="progress-meta">
      <div><strong>intentos:</strong> <span id="progress-attempts">0</span></div>
      <div><strong>fecha:</strong> <span id="progress-date">—</span></div>
      <div class="progress-row">
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
        <div class="progress-pct" id="progress-pct">0%</div>
      </div>
    </div>
    <button id="progress-close" type="button">CONTINUAR</button>
  </div>
</div>
<div id="dom-overlay" style="position:fixed; inset:0; pointer-events:none; z-index:10000">
  <div style="pointer-events:auto"> </div>
</div>

  <a-scene webxr="optionalFeatures: dom-overlay, hit-test; overlayElement: #dom-overlay" 
  vr-mode-ui="enabled: true">
    <a-assets>
      <canvas id="lavaCanvas" width="1024" height="1024"></canvas>
    </a-assets>
    <a-sky id="sky" material="shader: flat; src: #lavaCanvas"></a-sky>
    <a-entity camera look-controls position="0 1.6 0">
      <a-entity
        cursor="fuse: true; fuseTimeout: 1000"
        raycaster="objects: .clickable; interval: 0"
        position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
        material="color: #6b5ca5; shader: flat">
      </a-entity>
    </a-entity>
    <a-entity id="menu-dificultad">
      <a-text value="Inicia tu inmersion" position="0 2.3 -3" align="center" color="#4a4a6a" width="6"></a-text>
      <a-text id="micReminder" value="Recuerda revisar tu microfono!" position="0 2.0 -3" align="center" color="#746aa6" width="3" wrap-count="40" scale="0.8 0.8 0.8"></a-text>
      <a-box id="boton-facil" class="clickable" position="-2 1.2 -3" color="#9B5DE5" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="Facil" position="-1.7 1.3 -2.4" align="center" color="white" width="4"></a-text>

      <a-box id="boton-intermedio" class="clickable" position="0 1.2 -3" color="#7A3E9D" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="Intermedio" position="0 1.3 -2.4" align="center" color="white" width="4"></a-text>

      <a-box id="boton-dificil" class="clickable" position="2 1.2 -3" color="#6A0DAD" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="Dificil" position="1.7 1.3 -2.4" align="center" color="white" width="4"></a-text>
    </a-entity>

    <a-entity id="stars-facil"      position="-2 0.55 -3"></a-entity>
    <a-entity id="stars-intermedio" position="0  0.55 -3"></a-entity>
    <a-entity id="stars-dificil"    position="2  0.55 -3"></a-entity>
    <a-entity id="menu-tiempo" visible="false">
      <a-text value="Escoge el tiempo" position="0 2.6 -2.8" align="center" color="#4a4a6a" width="6"></a-text>

      <a-box id="boton-1min" class="clickable" position="-2 1.2 -3" color="#9B5DE5" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="1 minuto" position="-2 1.2 -2.8" align="center" color="white" width="3"></a-text>

      <a-box id="boton-2min" class="clickable" position="0 1.2 -3" color="#7A3E9D" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="2 minutos" position="0 1.2 -2.8" align="center" color="white" width="3"></a-text>

      <a-box id="boton-3min" class="clickable" position="2 1.2 -3" color="#6A0DAD" depth="0.3" height="0.6" width="1.8"></a-box>
      <a-text value="3 minutos" position="2 1.2 -2.8" align="center" color="white" width="3"></a-text>
    </a-entity>
  </a-scene>

  <script>
    const API_BASE = 'http://localhost:4000';

    async function ensureSession() {
      const r = await fetch(`${API_BASE}/api/auth/me`, { credentials:'include' });
      if (!r.ok) { location.href = 'index.html'; return null; }
      const me = await r.json();
      localStorage.setItem('user_id', me.user_id);
      return me;
    }

    const fmtDate = iso => (!iso ? '—' : (isNaN(new Date(iso)) ? '—' : new Date(iso).toLocaleString()));

function computePct(row){
  const stars = Math.round(Number(row?.max_stars || 0));
  if (stars >= 3) return 100;
  const raw = Number(row?.max_progress || 0);
  return Math.max(0, Math.min(100, Math.round(raw)));
}

function openProgressModal(row){
  const title = row.level_name || row.name || ('Nivel ' + row.level_id);
  document.getElementById('progress-title').textContent = `Progreso : ${title}`;


  const stars = Math.max(0, Math.round(row.max_stars || 0));
  document.getElementById('progress-stars').textContent = '★'.repeat(stars) || '—';
  document.getElementById('progress-attempts').textContent = row.attempts ?? 0;
  document.getElementById('progress-date').textContent = fmtDate(row.last_update || row.date);
  const pct = computePct(row);
  document.getElementById('progress-fill').style.width = `${pct}%`;
  document.getElementById('progress-pct').textContent = `${pct}%`;

  document.getElementById('progress-overlay').style.display = 'flex';
}



    document.getElementById('progress-close').onclick = () => {
      document.getElementById('progress-overlay').style.display = 'none';
    };

    const ID_TO_SLOT = { 1: 'stars-facil', 2: 'stars-intermedio', 3: 'stars-dificil' };

    const STAR_SVG = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 95">
        <path fill="#4b3fb8"
          d="M50 4l12.3 25 27.6 4-20 19.2 4.7 27.3L50 69.6 25.4 79.5l4.7-27.3-20-19.2 27.6-4L50 4z"/>
      </svg>
    `);
    const STAR_SRC = `data:image/svg+xml;utf8,${STAR_SVG}`;

    function coerceStars(row){ return Number(row?.max_stars ?? row?.stars ?? row?.best_stars ?? row?.max ?? 0); }

    function mountStarSlot(slotId, row){
      const slot = document.getElementById(slotId);
      if (!slot) return;

      while (slot.firstChild) slot.removeChild(slot.firstChild);

      const n = Math.max(0, Math.min(3, Math.round(coerceStars(row))));
      if (n <= 0){ slot.setAttribute('visible','false'); return; }

      slot.setAttribute('visible','true');

      const p = slot.object3D.position;
      slot.object3D.position.set(p.x, p.y, (p.z ?? 0) + 0.02);

      const hit = document.createElement('a-plane');
      hit.setAttribute('width', String(Math.max(1.2, n*0.3 + 0.2)));
      hit.setAttribute('height','0.35');
      hit.setAttribute('material','transparent:true; opacity:0.001; color:#fff');
      hit.classList.add('clickable');
      hit.addEventListener('click', () => openProgressModal(row));
      slot.appendChild(hit);

      const spacing = 0.3, size = 0.22, totalW = (n-1)*spacing, x0 = -totalW/2;
      for (let i=0;i<n;i++){
        const star = document.createElement('a-image');
        star.setAttribute('src', STAR_SRC);
        star.setAttribute('width', String(size));
        star.setAttribute('height', String(size));
        star.setAttribute('position', `${x0 + i*spacing} 0 0.01`);
        star.classList.add('clickable');
        star.addEventListener('click', () => openProgressModal(row));
        slot.appendChild(star);
      }
    }

    async function loadProgress(userId){
      const r = await fetch(`${API_BASE}/api/users/${userId}/progress`, { credentials:'include' });
      if (!r.ok) throw new Error('No se pudo cargar progreso');
      const rows = await r.json();
      console.log('Progreso API:', rows);

      Object.values(ID_TO_SLOT).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('visible','false');
      });

      const byId = Object.fromEntries(rows.map(row => [Number(row.level_id), row]));
      mountStarSlot(ID_TO_SLOT[1], byId[1]);
      mountStarSlot(ID_TO_SLOT[2], byId[2]);
      mountStarSlot(ID_TO_SLOT[3], byId[3]);
    }

    function setStarsVisible(flag){
      Object.values(ID_TO_SLOT).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.setAttribute('visible', !!flag);
      });
    }

    function filterLevelsByCurrent(currentLevelId) {
      const ALL_BTNS  = ['boton-facil','boton-intermedio','boton-dificil'];

      ALL_BTNS.forEach(id => {
        const el = document.getElementById(id);
        if (el){ el.classList.remove('clickable'); el.setAttribute('material','opacity:0.2'); }
      });

      const VIS_BY_LEVEL = {
        1: ['boton-facil'],
        2: ['boton-facil','boton-intermedio'],
        3: ['boton-facil','boton-intermedio','boton-dificil']
      };
      const allowed = VIS_BY_LEVEL[currentLevelId] || VIS_BY_LEVEL[1];

      allowed.forEach(id => {
        const el = document.getElementById(id);
        if (el){ el.setAttribute('material','opacity:1'); el.classList.add('clickable'); }
      });

      console.log(`current_level_id=${currentLevelId} → visibles:`, allowed.concat(Object.values(ID_TO_SLOT)));
    }

    document.querySelector('a-scene')?.addEventListener('loaded', async () => {
      const me = await ensureSession();
      if (!me) return;

      await loadProgress(me.user_id);
      filterLevelsByCurrent(me.current_level_id);

      const menuTiempo = document.getElementById('menu-tiempo');
      menuTiempo.addEventListener('componentchanged', (e) => {
        if (e.detail.name === 'visible') {
          const v = menuTiempo.getAttribute('visible');
          setStarsVisible(!v);
        }
      });
      setStarsVisible(!menuTiempo.getAttribute('visible'));
    });
  </script>
  <script src="./js/fondo-lava.js"></script>
  <script src="./js/logout.js"></script>
  <script src="./js/home-icon.js"></script>
  <script src="./js/logic.js" defer></script>
</body>
</html>
