<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selector principal</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
</head>
<body>

<div id="dom-overlay" style="position:fixed; inset:0; pointer-events:none; z-index:10000">
  <div style="pointer-events:auto"> </div>
</div>
<a-scene webxr="optionalFeatures: dom-overlay, hit-test; overlayElement: #dom-overlay" 
  vr-mode-ui="enabled: true">
  <a-assets>
       <canvas id="lavaCanvas" width="1024" height="1024"></canvas>

  </a-assets>
  <a-sky id="sky" material="shader: flat; src: #lavaCanvas"></a-sky>

  <a-entity camera look-controls position="0 1.6 0">
    <a-entity cursor="fuse: true; fuseTimeout: 1000"
              position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
              material="color: #6b5ca5; shader: flat">
    </a-entity>
  </a-entity>
    
  <a-entity id="logoutHUD" position=" 1 2 -2 ">
        <a-image
        id="logoutHUD"
        src="./logout.png"
        position="1.5 1 -1.2"
        width="0.90"
        height="0.35"
        class="clickable">
      </a-image>
  </a-entity>

  <a-entity id="selector">
    <a-text id="welcomeText" value="Bienvenido" position="0 2.3 -3" align="center" color="#3d3560" width="6"></a-text>

    <a-box id="btnPerfil" position="-2 1.2 -3" color="#5a4d8a" depth="0.3" height="0.6" width="1.8"></a-box>
    <a-text value="Ver Mi Perfil" align="center" width="3" color="white" position="-2 1.2 -2.8"></a-text>

    <a-box id="btnJuego" position="2 1.2 -3" color="#5a4d8a" depth="0.3" height="0.6" width="1.8"></a-box>
    <a-text value="Iniciar Exposicion" align="center" width="3" color="white" position="2 1.2 -2.8"></a-text>
  </a-entity>
</a-scene>
<script src="./js/api-base.js"></script>
<script>
  const API_BASE = 'https://vr-backend-api-asdperfqg9a4fncv.canadacentral-01.azurewebsites.net';

  async function ensureMicPermission() {
    try {
      if (navigator.permissions && navigator.permissions.query) {
        const st = await navigator.permissions.query({ name: 'microphone' });
        if (st.state === 'granted') return true;
      }
    } catch(_) {}
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
      return true;
    } catch(err) {
      alert('Necesitas permitir el micrófono para continuar usando la app. Actívalo desde el candado del navegador.');
      return false;
    }
  }

  async function ensureSession() {
    try {
      const r = await fetch(`${API_BASE}/api/auth/me`, { credentials:'include' });
      if (!r.ok) throw 0;
      const me = await r.json();
      localStorage.setItem('user_id', me.user_id);
      localStorage.setItem('username', me.username);
      return me;
    } catch {
      location.href = '../index.html';
    }
  }

  const username = localStorage.getItem('username');
  if (username) {
    const welcomeEl = document.querySelector('#welcomeText');
    welcomeEl.setAttribute('value', `Bienvenido ${username}!`);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await ensureSession();
    const micOk = await ensureMicPermission();
    if (!micOk) return;

    document.querySelector('#btnJuego').addEventListener('click', () => {
      window.location.href = 'main.html';
    });
    document.querySelector('#btnPerfil').addEventListener('click', () => {
      window.location.href = 'profile.html';
    });
  });

  const logoutHUD = document.getElementById('logoutHUD');

  logoutHUD.addEventListener('click', async () => {
    try {
      await fetch(`${API_BASE}/api/auth/logout`, {
        method: 'POST',
        credentials: 'include'
      });
    } catch (e) {
      console.warn("Logout error:", e);
    } finally {
      localStorage.clear();
      window.location.href = "/index.html";
    }
  });
</script>
<script src="./js/onboarding-gate1.js"></script>
<script src="./js/fondo-lava.js"></script>
</body>

</html>
